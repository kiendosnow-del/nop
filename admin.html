<script>
firebase.auth().onAuthStateChanged(async user=>{
  if(!user){
    alert("ChÆ°a Ä‘Äƒng nháº­p!");
    location.href="index.html";
    return;
  }

  const doc = await firebase.firestore()
    .collection("users")
    .doc(user.uid).get();

  if(doc.data().role !== "admin"){
    alert("âŒ KhÃ´ng cÃ³ quyá»n!");
    location.href="index.html";
  }
});
</script>
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>SNOW Admin</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#0b1220;color:white}
.card{background:#111b34;padding:15px;margin:15px;border-radius:12px}
button{padding:8px 14px;border:none;border-radius:6px;font-weight:bold}
.approve{background:#1e90ff;color:white}
.refund{background:#ff4d4d;color:white}
</style>
</head>

<body>

<h2 style="text-align:center">ğŸ‘‘ SNOW ADMIN PANEL</h2>
<div id="orders"></div>

<script>
/* ğŸ”¥ FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ğŸ” CHECK ADMIN */
auth.onAuthStateChanged(async user=>{
  if(!user){
    alert("ChÆ°a Ä‘Äƒng nháº­p");
    location.href="login.html";
    return;
  }

  const u = await db.collection("users").doc(user.uid).get();
  if(u.data().role !== "admin"){
    alert("KhÃ´ng cÃ³ quyá»n admin");
    auth.signOut();
    return;
  }

  loadOrders();
});

/* ğŸ“¦ LOAD ÄÆ N */
async function loadOrders(){
  const snap = await db.collection("orders").orderBy("time","desc").get();
  const div = document.getElementById("orders");
  div.innerHTML="";

  snap.forEach(doc=>{
    const o = doc.data();
    div.innerHTML += `
      <div class="card">
        <b>${o.username}</b><br>
        ğŸ“¦ ${o.goi}<br>
        ğŸ’° ${o.price.toLocaleString()}Ä‘<br>
        ğŸ“Œ Tráº¡ng thÃ¡i: ${o.status}<br><br>

        <button class="approve" onclick="duyet('${doc.id}','${o.uid}',${o.price})">
          âœ… Duyá»‡t
        </button>
        <button class="refund" onclick="hoan('${doc.id}','${o.uid}',${o.price})">
          ğŸ” HoÃ n tiá»n
        </button>
      </div>
    `;
  });
}

/* âœ… DUYá»†T */
async function duyet(id){
  await db.collection("orders").doc(id).update({status:"done"});
  alert("ÄÃ£ duyá»‡t");
  loadOrders();
}

/* ğŸ” HOÃ€N TIá»€N */
async function hoan(id, uid, price){
  const userRef = db.collection("users").doc(uid);

  await db.runTransaction(async t=>{
    const u = await t.get(userRef);
    t.update(userRef,{ wallet: u.data().wallet + price });
    t.update(db.collection("orders").doc(id),{ status:"refund" });
  });

  alert("ÄÃ£ hoÃ n tiá»n");
  loadOrders();
}
</script>
</body>
</html>
