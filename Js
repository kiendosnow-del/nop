auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const snap = await db.collection("users").doc(user.uid).get();
  if(!snap.exists || snap.data().role !== "admin"){
    alert("âŒ KhÃ´ng cÃ³ quyá»n admin");
    await auth.signOut();
    location.href="login.html";
  }
});
db.collection("orders")
.orderBy("time","desc")
.onSnapshot(snap=>{
  orderList.innerHTML="";
  snap.forEach(doc=>{
    const o = doc.data();
    orderList.innerHTML += `
      <div class="order">
        ğŸ‘¤ <b>${o.username}</b><br>
        ğŸ“¦ ${o.goi}<br>
        ğŸ’° ${o.price.toLocaleString()}Ä‘<br>
        ğŸ“Œ <b>${o.status}</b><br>

        ${o.status==="pending" ? `
          <button onclick="duyetDon('${doc.id}')">âœ… Duyá»‡t</button>
          <button onclick="hoanTien('${doc.id}','${o.uid}',${o.price})"
            style="background:#e74c3c">â†© HoÃ n tiá»n</button>
        ` : ""}
      </div>
    `;
  });
});
function duyetDon(id){
  db.collection("orders").doc(id).update({
    status:"done"
  }).then(()=>alert("âœ… ÄÃ£ duyá»‡t Ä‘Æ¡n"));
}
function hoanTien(orderId, uid, price){
  const uRef = db.collection("users").doc(uid);
  const oRef = db.collection("orders").doc(orderId);

  db.runTransaction(async t=>{
    const uSnap = await t.get(uRef);
    t.update(uRef,{
      wallet: (uSnap.data().wallet || 0) + price
    });
    t.update(oRef,{ status:"refund" });
  }).then(()=>alert("â†© ÄÃ£ hoÃ n tiá»n"));
}
db.collection("users").doc("UID_ADMIN").set({
  username: "admin_snow",
  wallet: 999999999,
  role: "admin",
  created: Date.now()
});
fetch(WEBHOOK,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({
    content:`ğŸ“¦ ÄÆ N Má»šI\nğŸ‘¤ ${username}\nğŸ“¦ ${goi}\nğŸ’° ${price.toLocaleString()}Ä‘`
  })
});
const API = "https://api-snow.workers.dev";

type.onchange = () => {
  cardBox.classList.toggle("hide", type.value !== "card");
  bankBox.classList.toggle("hide", type.value !== "bank");
};

auth.onAuthStateChanged(u=>{
  if(!u) return;
  const code = "SNOW"+u.uid.slice(0,6);
  napCode.innerText = code;
  qr.src =
`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=STK|BANK|TEN|${code}`;
});

function topup(){
  const u = auth.currentUser;
  if(type.value === "card"){
    fetch(API+"/card",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        uid:u.uid,
        telco:telco.value,
        amount:amount.value,
        serial:serial.value,
        code:code.value,
        request_id:u.uid
      })
    }).then(()=>alert("â³ Äang xá»­ lÃ½ tháº»"));
  }else{
    alert("ğŸ’¡ Chuyá»ƒn khoáº£n Ä‘Ãºng ná»™i dung, há»‡ thá»‘ng sáº½ tá»± cá»™ng tiá»n");
  }
}
db.collection("transactions")
.where("uid","==",auth.currentUser.uid)
.orderBy("time","desc")
.onSnapshot(s=>{
  history.innerHTML="";
  s.forEach(d=>{
    const t=d.data();
    history.innerHTML+=`
      <div class="order">
        ${t.type} | ${t.amount.toLocaleString()}Ä‘
      </div>`;
  });
});
match /users/{id} {
  allow read: if request.auth.uid == id;
  allow update: if false; // chá»‰ backend
}
