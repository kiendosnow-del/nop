<script>
// ğŸ“œ LOAD ÄÆ N + NÃšT DUYá»†T / HOÃ€N
db.collection("orders")
.orderBy("time","desc")
.onSnapshot(snap=>{
  orderList.innerHTML="";
  snap.forEach(doc=>{
    const o = doc.data();

    orderList.innerHTML += `
      <div class="order">
        ğŸ‘¤ <b>${o.username}</b><br>
        ğŸ“¦ ${o.goi}<br>
        ğŸ’° ${o.price.toLocaleString()}Ä‘<br>
        ğŸ“Œ Tráº¡ng thÃ¡i: <b>${o.status}</b><br>

        ${o.status==="pending" ? `
          <button onclick="duyetDon('${doc.id}')">âœ… Duyá»‡t</button>
          <button onclick="hoanTien('${doc.id}','${o.uid}',${o.price})"
            style="background:#e74c3c">â†© HoÃ n tiá»n</button>
        ` : ""}
      </div>
    `;
  });
});
</script>

<script>
function duyetDon(orderId){
  db.collection("orders").doc(orderId).update({
    status:"done"
  }).then(()=>{
    alert("âœ… ÄÃ£ duyá»‡t Ä‘Æ¡n");
  });
}

function hoanTien(orderId, uid, price){
  const userRef = db.collection("users").doc(uid);
  const orderRef = db.collection("orders").doc(orderId);

  db.runTransaction(async t=>{
    const u = await t.get(userRef);
    t.update(userRef,{
      wallet: u.data().wallet + price
    });
    t.update(orderRef,{
      status:"refund"
    });
  }).then(()=>{
    alert("â†© ÄÃ£ hoÃ n tiá»n");
  });
}
</script>
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const doc = await db.collection("users").doc(user.uid).get();
  if(!doc.exists || doc.data().role !== "admin"){
    alert("âŒ KhÃ´ng cÃ³ quyá»n admin");
    auth.signOut();
    location.href="login.html";
  }
});
db.collection("users").doc("UID_CUA_BAN").update({
  role:"admin",
  wallet:999999999
})
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const doc = await db.collection("users").doc(user.uid).get();
  if(!doc.exists || doc.data().role !== "admin"){
    auth.signOut();
    location.href="login.html";
  }
});
