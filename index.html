<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>â„ï¸ SNOW SHOP | CÃ y ThuÃª Blox Fruits</title>
<style>
:root{
  --bg:#0b1220;--card:#111827;--main:#38bdf8;--vip:#facc15;
  --text:#e5e7eb;--muted:#9ca3af}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.header{
  padding:18px;text-align:center;background:linear-gradient(135deg,#0284c7,#2563eb);
  position:sticky;top:0;z-index:10
}
.header .meta{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:8px;font-size:14px}
nav{display:flex;flex-wrap:wrap;justify-content:space-around;background:#020617;padding:8px 6px;position:sticky;top:72px;z-index:9}
nav button{background:none;border:none;color:#fff;font-weight:700;padding:8px;border-radius:8px;cursor:pointer}
.container{max-width:720px;margin:16px auto;padding:12px}
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.35)}
h3{color:var(--main);margin:4px 0 12px}
input,select,textarea,button{
  width:100%;padding:11px;margin:6px 0;border-radius:10px;border:none;background:#020617;color:#fff}
textarea{min-height:90px;resize:vertical}
.btn{background:var(--main);font-weight:700;cursor:pointer;border-radius:10px;padding:10px}
.hidden{display:none}
.small{font-size:13px;color:var(--muted)}
.detailBox{white-space:pre-line;background:#020617;padding:10px;border-radius:10px;margin-top:6px}
.log{font-size:13px;border-bottom:1px dashed #334155;padding:8px 0}
.flex{display:flex;gap:10px}
.col{flex:1}
.center{text-align:center}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#081126;color:var(--main);font-weight:600;font-size:13px}
.orderItem{border-radius:8px;padding:8px;margin-bottom:8px;background:linear-gradient(180deg,#07101a,#05080b);border:1px solid #0f1724}
.footerNote{font-size:13px;color:var(--muted);margin-top:8px}
@media (max-width:640px){
  .container{padding:8px}
  nav{font-size:14px}
}
</style>
</head>
<body>
<header class="header">
  <h1>â„ï¸ SNOW SHOP</h1>
  <div class="meta">
    <div>ğŸ‘¤ <b id="userLabel">ChÆ°a Ä‘Äƒng nháº­p</b></div>
    <div>ğŸ’° VÃ­: <b id="sodu">0</b>Ä‘</div>
  </div>
</header>

<nav id="mainNav" aria-label="Chá»©c nÄƒng chÃ­nh">
  <button data-tab="account">ğŸ‘¤ TÃ i khoáº£n</button>
  <button data-tab="shop">ğŸ›’ ThuÃª cÃ y</button>
  <button data-tab="lichsu">ğŸ“œ Lá»‹ch sá»­</button>
</nav>

<main class="container">

  <!-- ACCOUNT -->
  <section id="account" class="card" aria-labelledby="accountTitle">
    <h3 id="accountTitle">ğŸ‘¤ TÃ€I KHOáº¢N</h3>
    <div id="authBox">
      <input id="acc_user" placeholder="TÃªn Ä‘Äƒng nháº­p (vÃ­ dá»¥: user01)" />
      <input id="acc_pass" type="password" placeholder="Máº­t kháº©u" />
      <div class="flex">
        <button id="btnLogin" class="btn col">ÄÄƒng nháº­p</button>
        <button id="btnRegister" class="btn col" style="background:linear-gradient(135deg,#facc15,#eab308);color:#000">ÄÄƒng kÃ½</button>
      </div>
      <p class="footerNote">Máº­t kháº©u Ä‘Æ°á»£c bÄƒm báº±ng SHA-256 trÆ°á»›c khi lÆ°u (localStorage). KhÃ´ng dÃ¹ng tÃ i khoáº£n tháº­t quan trá»ng trÃªn demo nÃ y.</p>
    </div>

    <div id="logoutBox" class="hidden">
      <p>âœ… Xin chÃ o <b id="accName"></b></p>
      <div class="flex">
        <button id="btnLogout" class="btn col">ÄÄƒng xuáº¥t</button>
        <button id="btnGoShop" class="btn col" style="background:#0ea5e9">Äi tá»›i cá»­a hÃ ng</button>
      </div>
    </div>
  </section>

  <!-- SHOP -->
  <section id="shop" class="card hidden" aria-labelledby="shopTitle">
    <h3 id="shopTitle">ğŸ›’ THUÃŠ CÃ€Y BLOX FRUITS</h3>

    <input id="ten" placeholder="TÃªn Roblox / Discord" />
    <input id="login" placeholder="Login Roblox" />

    <select id="goi" aria-label="Chá»n gÃ³i">
      <option value="">-- Chá»n gÃ³i cÃ y thuÃª --</option>

      <optgroup label="ğŸ”° LEVEL">
        <option value="Level 700|20000" data-info="Farm nhanh lÃªn level 700" data-detail="âœ” Farm quest nhanh\nâœ” KhÃ´ng Ä‘á»•i trÃ¡i\nâœ” 3â€“5 giá»">Level 700 â€“ 20.000Ä‘</option>
        <option value="700 â†’ 1500|20000" data-info="Farm tá»« Sea 2" data-detail="âœ” Farm boss + quest\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1â€“2 ngÃ y">700 â†’ 1500 â€“ 20.000Ä‘</option>
        <option value="1500 â†’ 2800|20000" data-info="Farm Sea 3" data-detail="âœ” Farm full Sea 3\nâœ” An toÃ n 100%\nâœ” 2â€“3 ngÃ y">1500 â†’ 2800 â€“ 20.000Ä‘</option>
        <option value="0 â†’ MAX|50000" data-info="CÃ y tá»« Ä‘áº§u tá»›i max" data-detail="âœ” Full Sea 1â€“2â€“3\nâœ” KhÃ´ng máº¥t acc\nâœ” 4â€“6 ngÃ y">0 â†’ MAX â€“ 50.000Ä‘</option>
      </optgroup>

      <optgroup label="ğŸ’ ITEM">
        <option value="Má» Neo|20000" data-info="LÃ m Má» Neo" data-detail="âœ” Full quest\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1 ngÃ y">Má» Neo â€“ 20.000Ä‘</option>
        <option value="Tushita|15000" data-info="Kiáº¿m Tushita" data-detail="âœ” Full quest\nâœ” An toÃ n\nâœ” Trong ngÃ y">Tushita â€“ 15.000Ä‘</option>
        <option value="Yama|30000" data-info="Kiáº¿m Yama" data-detail="âœ” Full Yama\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1â€“2 ngÃ y">Yama â€“ 30.000Ä‘</option>
        <option value="Tam Kiáº¿m Full|35000" data-info="True Triple Katana" data-detail="âœ” Full 3 kiáº¿m\nâœ” KhÃ´ng rollback\nâœ” 2â€“3 ngÃ y">Tam Kiáº¿m Full â€“ 35.000Ä‘</option>
        <option value="CDK|30000" data-info="Cursed Dual Katana" data-detail="âœ” Full CDK\nâœ” KhÃ´ng máº¥t item\nâœ” 1â€“2 ngÃ y">CDK â€“ 30.000Ä‘</option>
      </optgroup>

      <optgroup label="ğŸ’  V4">
        <option value="Full Gear V4|30000" data-info="Full Gear V4" data-detail="âœ” Full Gear\nâœ” Thá»©c tá»‰nh V4\nâœ” 1â€“2 ngÃ y">Full Gear V4 â€“ 30.000Ä‘</option>
        <option value="1 Gear V4|5000" data-info="Up 1 Gear" data-detail="âœ” 1 Gear báº¥t ká»³\nâœ” Nhanh gá»n\nâœ” Trong ngÃ y">1 Gear V4 â€“ 5.000Ä‘</option>
      </optgroup>

      <optgroup label="ğŸ¥‹ MELEE">
        <option value="Godhuman|20000" data-info="Melee Godhuman" data-detail="âœ” Full Godhuman\nâœ” Farm nguyÃªn liá»‡u\nâœ” 1 ngÃ y">Godhuman â€“ 20.000Ä‘</option>
        <option value="Melee V2|15000" data-info="Up Melee V2" data-detail="âœ” Melee V2\nâœ” Nhanh\nâœ” Trong ngÃ y">Melee V2 â€“ 15.000Ä‘</option>
      </optgroup>
    </select>

    <div id="goiInfo" class="small"></div>
    <div id="goiDetail" class="detailBox hidden"></div>

    <textarea id="note" placeholder="Ghi chÃº thÃªm (cÃ¡c yÃªu cáº§u, pass, thá»i gian chÆ¡i... )"></textarea>
    <div class="flex">
      <button id="btnOrder" class="btn col">ğŸš€ Äáº¶T ÄÆ N</button>
      <button id="btnPreview" class="btn col" style="background:#0ea5e9">Xem trÆ°á»›c Ä‘Æ¡n</button>
    </div>

    <p class="footerNote">LÆ°u Ã½: Ä‘á»ƒ gá»­i webhook tá»›i Discord tá»« trÃ¬nh duyá»‡t cÃ³ thá»ƒ bá»‹ cháº·n do CORS. Há»‡ thá»‘ng sáº½ cá»‘ gáº¯ng gá»­i, náº¿u tháº¥t báº¡i báº¡n Ä‘Æ°á»£c cung cáº¥p payload Ä‘á»ƒ gá»­i qua server/backend.</p>
  </section>

  <!-- Lá»ŠCH Sá»¬ -->
  <section id="lichsu" class="card hidden" aria-labelledby="lichsuTitle">
    <h3 id="lichsuTitle">ğŸ“œ Lá»ŠCH Sá»¬ ÄÆ N</h3>
    <div id="ordersList" class="small"></div>
  </section>

</main>

<script>
/*
  IMPORTANT:
  - For production, DO NOT send webhooks directly from the browser; use a backend to avoid exposing tokens and handle CORS.
  - Replace DISCORD_WEBHOOK with your backend endpoint or keep empty and the UI will show the payload for server-side use.
*/
const DISCORD_WEBHOOK = ""; // <-- Put backend endpoint here, not a raw discord webhook URL

/* ---------- Utilities ---------- */
const qs = sel => document.querySelector(sel);
const qsa = sel => Array.from(document.querySelectorAll(sel));
const el = id => document.getElementById(id);

function formatCurrency(v){
  if(!v) return "0";
  return Number(v).toLocaleString("vi-VN");
}

async function sha256(message){
  const enc = new TextEncoder();
  const msgUint8 = enc.encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* ---------- Simple local "backend" ---------- */
const DB = {
  usersKey: 'snowshop_users_v1',
  ordersKey: 'snowshop_orders_v1',
  loadUsers(){
    return JSON.parse(localStorage.getItem(this.usersKey) || '{}');
  },
  saveUsers(u){
    localStorage.setItem(this.usersKey, JSON.stringify(u));
  },
  loadOrders(){
    return JSON.parse(localStorage.getItem(this.ordersKey) || '[]');
  },
  saveOrders(list){
    localStorage.setItem(this.ordersKey, JSON.stringify(list));
  }
};

function currentUser(){
  return JSON.parse(sessionStorage.getItem('snow_current_user') || 'null');
}
function setCurrentUser(u){
  if(u) sessionStorage.setItem('snow_current_user', JSON.stringify(u));
  else sessionStorage.removeItem('snow_current_user');
}

/* ---------- UI: tabs ---------- */
qsa('nav button').forEach(btn => btn.addEventListener('click', () => {
  const tab = btn.dataset.tab;
  openTab(tab);
}));

function openTab(name){
  qsa('main > section').forEach(s => s.classList.add('hidden'));
  const target = el(name);
  if(target) target.classList.remove('hidden');
  // Optional: focus first input
  const fi = target && target.querySelector('input,select,textarea,button');
  if(fi) fi.focus();
}

/* ---------- Account logic ---------- */
async function registerAcc(){
  const user = el('acc_user').value.trim();
  const pass = el('acc_pass').value;
  if(!user || !pass){ alert('Nháº­p tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u'); return; }
  const users = DB.loadUsers();
  if(users[user]){ alert('TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i'); return; }
  const passHash = await sha256(pass);
  users[user] = { username: user, passHash, balance: 0 };
  DB.saveUsers(users);
  alert('ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p.');
  el('acc_pass').value = '';
}

async function loginAcc(){
  const user = el('acc_user').value.trim();
  const pass = el('acc_pass').value;
  if(!user || !pass){ alert('Nháº­p tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u'); return; }
  const users = DB.loadUsers();
  const record = users[user];
  if(!record){ alert('KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n'); return; }
  const hash = await sha256(pass);
  if(hash !== record.passHash){ alert('Máº­t kháº©u sai'); return; }
  setCurrentUser({ username:user });
  refreshAuthUI();
  alert('ÄÄƒng nháº­p thÃ nh cÃ´ng');
}

function logout(){
  setCurrentUser(null);
  refreshAuthUI();
}

function refreshAuthUI(){
  const cur = currentUser();
  if(cur){
    el('authBox').classList.add('hidden');
    el('logoutBox').classList.remove('hidden');
    el('accName').textContent = cur.username;
    el('userLabel').textContent = cur.username;
    // show balance
    const users = DB.loadUsers();
    const bal = (users[cur.username] && users[cur.username].balance) || 0;
    el('sodu').textContent = formatCurrency(bal);
  } else {
    el('authBox').classList.remove('hidden');
    el('logoutBox').classList.add('hidden');
    el('userLabel').textContent = 'ChÆ°a Ä‘Äƒng nháº­p';
    el('sodu').textContent = '0';
  }
}

/* ---------- Shop interactions ---------- */
const goiEl = el('goi');
goiEl.addEventListener('change', () => {
  const opt = goiEl.selectedOptions[0];
  if(!opt || !opt.value){ el('goiInfo').textContent=''; el('goiDetail').classList.add('hidden'); return; }
  el('goiInfo').textContent = opt.dataset.info || '';
  const detail = opt.dataset.detail || opt.getAttribute('data-detail') || '';
  el('goiDetail').textContent = detail.trim();
  el('goiDetail').classList.toggle('hidden', !detail);
});

el('btnPreview').addEventListener('click', previewOrder);
el('btnOrder').addEventListener('click', datDon);
el('btnGoShop').addEventListener('click', () => openTab('shop'));
el('btnLogout').addEventListener('click', logout);
el('btnLogin').addEventListener('click', loginAcc);
el('btnRegister').addEventListener('click', registerAcc);

/* ---------- Orders ---------- */
function parsePackageValue(val){
  // format: "Name|price"
  const [name, price] = (val || '').split('|');
  return { name: name || '', price: Number(price||0) || 0 };
}

function buildOrderPayload(order){
  return {
    username: order.username,
    name: order.name,
    login: order.login,
    package: order.package,
    price: order.price,
    note: order.note,
    created_at: order.createdAt
  };
}

function saveOrder(order){
  const list = DB.loadOrders();
  list.unshift(order);
  DB.saveOrders(list);
  renderOrdersList();
}

/* Try to send to webhook (CORS likely blocked if direct discord webhook used). */
async function sendOrderToWebhook(order){
  if(!DISCORD_WEBHOOK) throw new Error('No webhook configured on client');
  // Expect DISCORD_WEBHOOK to be a backend endpoint that will forward to Discord
  const payload = {
    embeds: [{
      title: `ÄÆ¡n hÃ ng má»›i: ${order.package}`,
      color: 3447003,
      fields: [
        { name: 'NgÆ°á»i Ä‘áº·t', value: order.username || 'â€”', inline: true },
        { name: 'TÃªn/Discord', value: order.name || 'â€”', inline: true },
        { name: 'Login', value: order.login || 'â€”', inline: true },
        { name: 'GÃ³i', value: order.package, inline: true },
        { name: 'GiÃ¡', value: formatCurrency(order.price) + 'Ä‘', inline: true },
        { name: 'Ghi chÃº', value: order.note || 'â€”', inline: false },
      ],
      timestamp: new Date(order.createdAt).toISOString()
    }]
  };
  const res = await fetch(DISCORD_WEBHOOK, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error(`Server returned ${res.status}`);
  return res;
}

async function datDon(){
  const cur = currentUser();
  if(!cur){ if(confirm('Báº¡n chÆ°a Ä‘Äƒng nháº­p. ÄÄƒng nháº­p bÃ¢y giá»?')) openTab('account'); return; }
  const name = el('ten').value.trim();
  const login = el('login').value.trim();
  const goiVal = el('goi').value;
  if(!goiVal){ alert('Chá»n gÃ³i'); return; }
  const pkg = parsePackageValue(goiVal);
  const note = el('note').value.trim();
  // Confirm
  if(!confirm(`XÃ¡c nháº­n Ä‘áº·t: ${pkg.name} â€” ${formatCurrency(pkg.price)}Ä‘ ?`)) return;

  const order = {
    id: 'o_' + Date.now(),
    username: cur.username,
    name, login,
    package: pkg.name,
    price: pkg.price,
    note,
    createdAt: Date.now(),
    sent: false
  };

  // Save locally first
  saveOrder(order);

  // Try send
  try {
    await sendOrderToWebhook(order);
    order.sent = true;
    // update saved order
    const list = DB.loadOrders();
    const idx = list.findIndex(o => o.id === order.id);
    if(idx>=0){ list[idx] = order; DB.saveOrders(list); renderOrdersList(); }
    alert('ÄÆ¡n Ä‘Ã£ gá»­i thÃ nh cÃ´ng!');
  } catch (err){
    console.warn('Send webhook failed:', err);
    // Fallback: copy payload to clipboard for server-side forwarding
    const payload = JSON.stringify(buildOrderPayload(order), null, 2);
    await navigator.clipboard.writeText(payload).catch(()=>{});
    alert('KhÃ´ng thá»ƒ gá»­i trá»±c tiáº¿p (CORS/khÃ´ng cáº¥u hÃ¬nh webhook). Payload Ä‘Ã£ Ä‘Æ°á»£c sao chÃ©p Ä‘á»ƒ gá»­i qua backend.');
  }
  // clear form
  el('ten').value=''; el('login').value=''; el('note').value=''; el('goi').value='';
  el('goiInfo').textContent=''; el('goiDetail').classList.add('hidden');
}

/* Preview order */
function previewOrder(){
  const cur = currentUser();
  const name = el('ten').value.trim();
  const login = el('login').value.trim();
  const goiVal = el('goi').value;
  if(!goiVal){ alert('Chá»n gÃ³i Ä‘á»ƒ xem trÆ°á»›c'); return; }
  const pkg = parsePackageValue(goiVal);
  const note = el('note').value.trim();
  const s = `=== XEM TRÆ¯á»šC ÄÆ N ===
NgÆ°á»i Ä‘áº·t: ${cur ? cur.username : 'ChÆ°a Ä‘Äƒng nháº­p'}
TÃªn/Discord: ${name || 'â€”'}
Login: ${login || 'â€”'}
GÃ³i: ${pkg.name}
GiÃ¡: ${formatCurrency(pkg.price)}Ä‘
Ghi chÃº: ${note || 'â€”'}`;
  alert(s);
}

/* ---------- Orders UI ---------- */
function renderOrdersList(){
  const list = DB.loadOrders();
  const container = el('ordersList');
  if(!container) return;
  if(list.length===0){
    container.innerHTML = '<p class="small">ChÆ°a cÃ³ Ä‘Æ¡n nÃ o.</p>';
    return;
  }
  container.innerHTML = list.map(o => {
    return `<div class="orderItem">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${escapeHtml(o.package)}</strong>
        <span class="badge">${o.sent ? 'sent' : 'pending'}</span>
      </div>
      <div class="small">NgÆ°á»i: ${escapeHtml(o.username)} â€¢ TÃªn: ${escapeHtml(o.name)} â€¢ Login: ${escapeHtml(o.login)}</div>
      <div class="small">GiÃ¡: ${formatCurrency(o.price)}Ä‘ â€¢ <span class="small">${new Date(o.createdAt).toLocaleString()}</span></div>
      <div style="margin-top:6px" class="small">Ghi chÃº: ${escapeHtml(o.note||'â€”')}</div>
    </div>`;
  }).join('');
}

/* ---------- Small helpers ---------- */
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
}

/* ---------- Init ---------- */
(function init(){
  (async()=>{
    // No built-in admin account anymore (removed per request).
    refreshAuthUI();
    renderOrdersList();
    openTab('account');
  })();
})();

</script>
</body>
</html>
