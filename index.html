<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>â„ï¸ SNOW SHOP â€” Fixed & Optimized</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body{font-family:'Segoe UI',sans-serif;background:#f1f5f9;margin:0;padding-bottom:80px;color:#334155}
        .box{background:#fff;margin:12px;border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
        button{background:#38bdf8;border:0;padding:10px 14px;border-radius:10px;font-weight:bold;margin:6px 0;cursor:pointer;color:#fff;transition:0.2s}
        button:hover{opacity:0.8}
        button.red{background:#ef4444} button.green{background:#22c55e} button.purple{background:#a855f7} button.gray{background:#64748b}
        input,select{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:1px solid #e2e8f0;box-sizing:border-box}
        .badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:bold}
        .bg-wait{background:#fef3c7;color:#d97706} .bg-process{background:#f3e8ff;color:#7c3aed} .bg-done{background:#dcfce7;color:#16a34a}
        .tab-btn{background:#fff;color:#64748b;border:1px solid #e2e8f0;margin-right:5px; padding: 10px 15px}
        .tab-btn.active{background:#38bdf8;color:#fff;border-color:#38bdf8}
        #modalOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,0.6);display:none;z-index:1000;backdrop-filter:blur(3px)}
        .modal{background:#fff;width:90%;max-width:450px;margin:50px auto;border-radius:16px;padding:20px;position:relative}
        .detail-box { background: #f8fafc; border-left: 4px solid #38bdf8; padding: 10px; margin: 10px 0; font-size: 13px; display: none; white-space: pre-line; }
        .history-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 13px; }
    </style>
</head>
<body>

<div class="box" style="display:flex; justify-content:space-between; align-items:center; background:linear-gradient(to right, #fff, #f0f9ff)">
    <div>
        <div style="font-size:12px; color:#64748b">ChÃ o, <b id="uName">KhÃ¡ch</b></div>
        <div style="font-size:18px; font-weight:bold; color:#16a34a">ğŸ’° <span id="uBalance">0</span> Ä‘</div>
    </div>
    <div id="authButtons"><button onclick="showLogin()">ğŸ”‘ ÄÄƒng nháº­p</button></div>
    <div id="userButtons" style="display:none"><button onclick="logout()" class="red">ThoÃ¡t</button></div>
</div>

<div class="box" style="display:flex; overflow-x: auto; gap: 5px; border:none; background:transparent; box-shadow:none">
    <button class="tab-btn active" onclick="showMainTab('caythue', this)">ğŸ® CÃ y ThuÃª</button>
    <button class="tab-btn" onclick="showMainTab('lichsu', this)">ğŸ“œ Lá»‹ch sá»­</button>
    <button id="tabAdminBtn" class="tab-btn" style="display:none; color:red" onclick="showMainTab('adminShop', this)">âš™ï¸ ADMIN PANEL</button>
</div>

<div id="tabCayThue" class="main-tab">
    <div class="box">
        <h3>ğŸ›’ Dá»‹ch vá»¥ cÃ y thuÃª</h3>
        <select id="goi" onchange="updateServiceDetail()">
            <option value="">-- Chá»n gÃ³i --</option>
            <optgroup label="ğŸ”° LEVEL">
                <option value="Level 700|20000" data-info="Farm nhanh lÃªn level 700" data-detail="âœ” Farm quest nhanh&#10;âœ” KhÃ´ng Ä‘á»•i trÃ¡i&#10;âœ” 3â€“5 giá»">Level 700 â€“ 20.000Ä‘</option>
                <option value="0 â†’ MAX|50000" data-info="CÃ y tá»« Ä‘áº§u tá»›i max" data-detail="âœ” Full Sea 1â€“2â€“3&#10;âœ” KhÃ´ng máº¥t acc&#10;âœ” 4â€“6 ngÃ y">0 â†’ MAX â€“ 50.000Ä‘</option>
            </optgroup>
            <optgroup label="ğŸ’ ITEM">
                <option value="CDK|30000" data-info="Cursed Dual Katana" data-detail="âœ” Full CDK&#10;âœ” KhÃ´ng máº¥t item&#10;âœ” 1â€“2 ngÃ y">CDK â€“ 30.000Ä‘</option>
            </optgroup>
        </select>
        <div id="serviceDetail" class="detail-box"></div>
        <input id="accRoblox" placeholder="TÃ i khoáº£n Roblox">
        <input id="passRoblox" type="password" placeholder="Máº­t kháº©u">
        <button class="green" style="width:100%" onclick="handleBuyService()">XÃC NHáº¬N THANH TOÃN</button>
        <button class="purple" style="width:100%" onclick="showNapBank()">ğŸ’³ Náº P TIá»€N QUA BANK</button>
    </div>
</div>

<div id="tabLichSu" class="main-tab" style="display:none">
    <div class="box"><h3>ğŸ“œ ÄÆ¡n cÃ y cá»§a báº¡n</h3><div id="historyService"></div></div>
    <div class="box"><h3>ğŸ’° Lá»‹ch sá»­ náº¡p tiá»n</h3><div id="historyNap"></div></div>
</div>

<div id="tabAdminShop" class="main-tab" style="display:none">
    <div class="box">
        <h3>ğŸ‘¥ Danh sÃ¡ch ngÆ°á»i dÃ¹ng</h3>
        <div id="adminUserList" style="max-height: 250px; overflow-y: auto; background:#f8fafc; padding:10px; border-radius:10px"></div>
    </div>
    <div class="box">
        <h3>ğŸ”¥ Nick Ä‘ang bÃ¡n</h3>
        <div id="nickList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    </div>
</div>

<div id="adminView" style="display:none">
    <div class="box" style="border: 2px solid #ef4444; background:#fff5f5">
        <h2 style="color:#ef4444; margin-top:0">ğŸ›  QUáº¢N TRá»Š VIÃŠN</h2>
        <div style="display:flex; gap:5px; margin-bottom:10px; overflow-x:auto; padding-bottom:5px">
            <button class="gray" onclick="showAdminTab('orders')">ÄÆ¡n CÃ y</button>
            <button class="gray" onclick="showAdminTab('naps')">Duyá»‡t Náº¡p</button>
            <button class="gray" onclick="showAdminTab('addnick')">ThÃªm Nick</button>
            <button class="gray" onclick="showAdminTab('gift')">Cáº¥p Tiá»n</button>
        </div>
        <div id="admOrders" class="adm-tab"><div id="adminOrderList"></div></div>
        <div id="admNaps" class="adm-tab" style="display:none"><div id="adminNapList"></div></div>
        <div id="admAddNick" class="adm-tab" style="display:none">
            <input id="niTitle" placeholder="TiÃªu Ä‘á» Nick">
            <input id="niPrice" type="number" placeholder="GiÃ¡ bÃ¡n">
            <input id="niAcc" placeholder="TÃ i khoáº£n Nick">
            <input id="niPass" placeholder="Máº­t kháº©u Nick">
            <button class="green" style="width:100%" onclick="adminAddNick()">ÄÄ‚NG NICK</button>
        </div>
        <div id="admGift" class="adm-tab" style="display:none">
            <input id="adTargetUser" placeholder="TÃªn khÃ¡ch hÃ ng">
            <input id="adAmount" type="number" placeholder="Sá»‘ tiá»n cá»™ng">
            <button class="green" style="width:100%" onclick="adminGiftMoney()">Cá»˜NG TIá»€N</button>
        </div>
    </div>
</div>

<div id="modalOverlay"><div class="modal" id="modalContent"></div></div>

<script>
// Cáº¤U HÃŒNH WEBHOOK & ADMIN
const ADMIN_CONFIG = { user: "admin", pass: "admin123" };
const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1465766081548390534/iClDUAzau9xqGY3PFZTS6CT24uspMk8w5gLBvKyVyhjcxvuf-SD07-y9f9pC8Vax5lHE";

let cur = null;
let db_users = JSON.parse(localStorage.getItem('snow_users') || '{}');
let db_orders = JSON.parse(localStorage.getItem('snow_orders') || '[]');
let db_naps = JSON.parse(localStorage.getItem('snow_naps') || '[]');
let db_nicks = JSON.parse(localStorage.getItem('snow_nicks') || '[]');

function save() {
    localStorage.setItem('snow_users', JSON.stringify(db_users));
    localStorage.setItem('snow_orders', JSON.stringify(db_orders));
    localStorage.setItem('snow_naps', JSON.stringify(db_naps));
    localStorage.setItem('snow_nicks', JSON.stringify(db_nicks));
}

// FIX: TÃ¡ch hÃ m gá»­i Discord riÃªng Ä‘á»ƒ khÃ´ng lÃ m treo giao diá»‡n
async function sendDiscord(msg) {
    fetch(DISCORD_WEBHOOK, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content: msg })
    }).catch(e => console.log("Lá»—i Webhook"));
}

function render() {
    const session = localStorage.getItem('snow_session');
    if(!session || !db_users[session]) {
        cur = null;
        document.getElementById('uName').innerText = "KhÃ¡ch";
        document.getElementById('uBalance').innerText = "0";
        document.getElementById('authButtons').style.display = "block";
        document.getElementById('userButtons').style.display = "none";
        document.getElementById('adminView').style.display = "none";
        document.getElementById('tabAdminBtn').style.display = "none";
    } else {
        cur = db_users[session];
        document.getElementById('uName').innerText = cur.username;
        document.getElementById('uBalance').innerText = cur.balance.toLocaleString();
        document.getElementById('authButtons').style.display = "none";
        document.getElementById('userButtons').style.display = "block";
        
        const isAdmin = (cur.username === ADMIN_CONFIG.user);
        document.getElementById('adminView').style.display = isAdmin ? "block" : "none";
        document.getElementById('tabAdminBtn').style.display = isAdmin ? "block" : "none";
        
        // Render Lá»‹ch sá»­ cÃ y
        const myOrders = db_orders.filter(o => o.buyer === cur.username);
        document.getElementById('historyService').innerHTML = myOrders.length ? myOrders.reverse().map(o => `
            <div class="history-item"><b>${o.goi}</b> - <span class="badge ${getStatusClass(o.status)}">${o.status}</span></div>
        `).join('') : "ChÆ°a cÃ³ Ä‘Æ¡n.";

        // Render Lá»‹ch sá»­ náº¡p
        const myNaps = db_naps.filter(n => n.username === cur.username);
        document.getElementById('historyNap').innerHTML = myNaps.length ? myNaps.reverse().map(n => `
            <div class="history-item">Náº¡p <b>${n.amount.toLocaleString()}Ä‘</b> - <span class="badge ${n.status==='Xong'?'bg-done':'bg-wait'}">${n.status}</span></div>
        `).join('') : "ChÆ°a cÃ³ náº¡p.";

        if(isAdmin) {
            renderAdminData();
        }
    }
}

function renderAdminData() {
    // FIX: Render danh sÃ¡ch ngÆ°á»i dÃ¹ng chÃ­nh xÃ¡c
    document.getElementById('adminUserList').innerHTML = Object.keys(db_users).map(k => `
        <div class="history-item">ğŸ‘¤ <b>${k}</b> | ğŸ’° ${db_users[k].balance.toLocaleString()}Ä‘ | ğŸ”‘ ${db_users[k].password}</div>
    `).join('');

    // Render danh sÃ¡ch quáº£n lÃ½ Ä‘Æ¡n cÃ y
    document.getElementById('adminOrderList').innerHTML = db_orders.map((o, i) => `
        <div class="box" style="font-size:12px; border-left:4px solid #38bdf8">
            <b>${o.buyer}</b> Ä‘áº·t ${o.goi} [${o.status}]<br>TK: ${o.acc} | MK: ${o.pass}<br>
            <button onclick="updateStatus(${i}, 'ÄÃ£ duyá»‡t')" class="gray" style="font-size:10px">Duyá»‡t</button>
            <button onclick="updateStatus(${i}, 'Äang cÃ y')" class="purple" style="font-size:10px">CÃ y</button>
            <button onclick="updateStatus(${i}, 'Xong')" class="green" style="font-size:10px">DONE</button>
            <button onclick="deleteOrder(${i})" class="red" style="font-size:10px">XoÃ¡</button>
        </div>
    `).reverse().join('');

    // Render quáº£n lÃ½ náº¡p tiá»n
    document.getElementById('adminNapList').innerHTML = db_naps.map((n, i) => `
        <div class="box"><b>${n.username}</b> náº¡p ${n.amount.toLocaleString()}Ä‘<br>
            ${n.status === 'Chá» duyá»‡t' ? `<button onclick="approveNap(${i})" class="green">Cá»˜NG TIá»€N</button>` : '<span class="badge bg-done">ÄÃ£ duyá»‡t</span>'}
            <button onclick="db_naps.splice(${i},1); save(); render();" class="red" style="font-size:10px">XoÃ¡</button>
        </div>
    `).reverse().join('');

    // Render danh sÃ¡ch nick Ä‘ang bÃ¡n
    const listN = db_nicks.filter(n => !n.soldTo);
    document.getElementById('nickList').innerHTML = listN.map((n, i) => `
        <div style="border:1px solid #eee; padding:10px; border-radius:10px; text-align:center">
            <small>${n.title}</small><br><b>${n.price.toLocaleString()}Ä‘</b><br>
            <button class="red" style="padding:4px 8px; font-size:10px" onclick="db_nicks.splice(${i},1); save(); render();">XoÃ¡</button>
        </div>
    `).join('') || "Háº¿t hÃ ng";
}

// Xá»­ lÃ½ náº¡p tiá»n
function showNapBank() {
    if(!cur) return alert("Vui lÃ²ng Ä‘Äƒng nháº­p!");
    openModal(`
        <h3>ğŸ’³ Náº¡p tiá»n qua Bank</h3>
        <p>STK: <b style="color:red">1373727384</b> (MB BANK)<br>Ná»™i dung: <b>NAP ${cur.username}</b></p>
        <input id="naAmt" type="number" placeholder="Sá»‘ tiá»n Ä‘Ã£ chuyá»ƒn">
        <button class="green" style="width:100%" onclick="submitNap()">XÃC NHáº¬N ÄÃƒ CHUYá»‚N</button>
    `);
}

function submitNap() {
    const amt = parseInt(document.getElementById('naAmt').value);
    if(!amt || amt < 1000) return alert("Sá»‘ tiá»n khÃ´ng há»£p lá»‡!");
    db_naps.push({ username: cur.username, amount: amt, status: 'Chá» duyá»‡t' });
    save(); closeModal(); render();
    sendDiscord(`ğŸ’° **YÃŠU Cáº¦U Náº P TIá»€N**\nğŸ‘¤ User: ${cur.username}\nğŸ’µ Sá»‘ tiá»n: ${amt.toLocaleString()}Ä‘`);
    alert("ÄÃ£ gá»­i yÃªu cáº§u!");
}

// Xá»­ lÃ½ Ä‘áº·t Ä‘Æ¡n
function handleBuyService() {
    if(!cur) return alert("Vui lÃ²ng Ä‘Äƒng nháº­p!");
    const g = document.getElementById('goi').value;
    const acc = document.getElementById('accRoblox').value.trim();
    const pass = document.getElementById('passRoblox').value.trim();
    if(!g || !acc || !pass) return alert("Vui lÃ²ng nháº­p Ä‘á»§!");
    
    const [name, price] = g.split('|');
    const p = parseInt(price);
    if(cur.balance < p) return alert("Sá»‘ dÆ° khÃ´ng Ä‘á»§!");

    db_users[cur.username].balance -= p;
    db_orders.push({ buyer: cur.username, goi: name, acc, pass, status: "Chá» duyá»‡t", time: new Date().toLocaleString() });
    save(); render();
    sendDiscord(`ğŸ›’ **ÄÆ N Má»šI**\nğŸ‘¤ KhÃ¡ch: ${cur.username}\nğŸ“¦ GÃ³i: ${name}\nğŸ”‘ TK: ${acc} | MK: ${pass}`);
    alert("Äáº·t Ä‘Æ¡n thÃ nh cÃ´ng!");
}

// --- HÃ€M CÆ  Báº¢N ---
function updateStatus(i, s) { db_orders[i].status = s; save(); render(); }
function deleteOrder(i) { if(confirm("XoÃ¡ Ä‘Æ¡n nÃ y?")) { db_orders.splice(i,1); save(); render(); } }
function approveNap(i) {
    const n = db_naps[i];
    if(db_users[n.username]) {
        db_users[n.username].balance += n.amount;
        db_naps[i].status = "Xong";
        save(); render();
        alert("ÄÃ£ cá»™ng tiá»n!");
    }
}
function adminAddNick() {
    const t = document.getElementById('niTitle').value, p = parseInt(document.getElementById('niPrice').value);
    const a = document.getElementById('niAcc').value, ps = document.getElementById('niPass').value;
    if(!t || !p || !a) return alert("Nháº­p Ä‘á»§!");
    db_nicks.push({ title: t, price: p, acc: a, pass: ps, soldTo: null });
    save(); render(); alert("ÄÃ£ Ä‘Äƒng!");
}
function adminGiftMoney() {
    const u = document.getElementById('adTargetUser').value.trim(), a = parseInt(document.getElementById('adAmount').value);
    if(db_users[u]) { db_users[u].balance += a; save(); render(); alert("ÄÃ£ cá»™ng!"); } else alert("Sai user!");
}
function showMainTab(id, btn) {
    document.querySelectorAll('.main-tab').forEach(t => t.style.display = 'none');
    document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1)).style.display = 'block';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}
function showAdminTab(id) {
    document.querySelectorAll('.adm-tab').forEach(t => t.style.display = 'none');
    document.getElementById('adm' + id.charAt(0).toUpperCase() + id.slice(1)).style.display = 'block';
}
function updateServiceDetail() {
    const select = document.getElementById('goi'), opt = select.options[select.selectedIndex];
    const d = document.getElementById('serviceDetail');
    if(opt.value){ d.innerHTML = `<b>${opt.getAttribute('data-info')}</b>\n${opt.getAttribute('data-detail')}`; d.style.display = 'block'; }
    else d.style.display = 'none';
}
function showLogin() { openModal(`<h3>ğŸ”‘ ÄÄƒng nháº­p / ÄÄƒng kÃ½</h3><input id="au" placeholder="TÃªn tÃ i khoáº£n"><input id="ap" type="password" placeholder="Máº­t kháº©u"><button class="green" style="width:100%" onclick="handleAuth()">VÃ€O SHOP</button>`); }
function handleAuth() {
    const u = document.getElementById('au').value.trim(), p = document.getElementById('ap').value;
    if(!u || !p) return;
    if(!db_users[u]) db_users[u] = { username: u, password: p, balance: 0 };
    else if(db_users[u].password !== p) return alert("Sai máº­t kháº©u");
    localStorage.setItem('snow_session', u); save(); closeModal(); render();
}
function logout() { localStorage.removeItem('snow_session'); location.reload(); }
function openModal(h) { document.getElementById('modalContent').innerHTML = h + `<button class="red" style="width:100%" onclick="closeModal()">ÄÃ³ng</button>`; document.getElementById('modalOverlay').style.display = "block"; }
function closeModal() { document.getElementById('modalOverlay').style.display = "none"; }
function getStatusClass(s){ return s==='Xong'?'bg-done':(s==='Äang cÃ y'?'bg-process':'bg-wait'); }

window.onload = render;
</script>
</body>
</html>
