<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>â„ï¸ SNOW SHOP â€” ÄÃ£ Fix ToÃ n Bá»™ Lá»—i</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body{font-family:'Segoe UI',sans-serif;background:#f1f5f9;margin:0;padding-bottom:100px;color:#334155}
        .box{background:#fff;margin:12px;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
        button{border:0;padding:12px;border-radius:8px;font-weight:600;margin:5px 0;cursor:pointer;color:#fff;transition:0.2s}
        button:active{transform:scale(0.98)}
        .blue{background:#38bdf8} .red{background:#ef4444} .green{background:#22c55e} .purple{background:#8b5cf6}
        input,select{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
        .item-list{padding:10px;border-bottom:1px solid #f1f5f9;font-size:14px}
        .status{font-weight:bold;padding:2px 6px;border-radius:4px;font-size:12px}
        .wait{color:#f59e0b;background:#fffbeb}
        .done{color:#22c55e;background:#dcfce7}
    </style>
</head>
<body>

<div class="box" style="display:flex; justify-content:space-between; align-items:center">
    <div>
        ğŸ‘¤ <b id="u">KhÃ¡ch</b> <br>
        ğŸ’° <b id="b" style="color:#22c55e">0</b> <span style="font-size:12px">VNÄ</span>
    </div>
    <button class="red" id="btnLogout" style="display:none; padding:6px 10px">ThoÃ¡t</button>
</div>

<div id="auth_sec" class="box">
    <h3 style="margin-top:0">ğŸ” ÄÄƒng nháº­p / ÄÄƒng kÃ½</h3>
    <input id="au" placeholder="TÃªn tÃ i khoáº£n...">
    <input id="ap" type="password" placeholder="Máº­t kháº©u...">
    <button class="blue" id="btnLogin" style="width:100%">VÃ€O Há»† THá»NG</button>
</div>

<div id="main_sec" style="display:none">
    <div class="box">
        <h3 style="margin-top:0">ğŸ›’ Dá»‹ch vá»¥ CÃ y ThuÃª</h3>
        <select id="goi">
            <option value="">-- Chá»n gÃ³i dá»‹ch vá»¥ --</option>
            <option value="Level 700|20000">GÃ³i Level 700 - 20,000Ä‘</option>
            <option value="700-1500|40000">GÃ³i 700 â†’ 1500 - 40,000Ä‘</option>
            <option value="1500-Max|60000">GÃ³i 1500 â†’ Max - 60,000Ä‘</option>
            <option value="CDK|30000">Láº¥y kiáº¿m CDK - 30,000Ä‘</option>
        </select>
        <input type="text" id="g_u" placeholder="TÃ i khoáº£n Roblox">
        <input type="text" id="g_p" placeholder="Máº­t kháº©u Roblox">
        <button class="green" id="btnOrder" style="width:100%; margin-top:10px">XÃC NHáº¬N MUA NGAY</button>
    </div>

    <div class="box">
        <h3 style="margin-top:0">ğŸ“œ Lá»‹ch sá»­ cá»§a báº¡n</h3>
        <div id="his">Äang táº£i lá»‹ch sá»­...</div>
    </div>
</div>

<script>
/* ----- Cáº¥u trÃºc dá»¯ liá»‡u ----- */
let cur = null;
const uKey = (name) => 'user_' + name.toLowerCase().trim();

// HÃ m láº¥y dá»¯ liá»‡u chuáº©n
function getDB(k, def) {
    try { return JSON.parse(localStorage.getItem(k)) || def; } catch(e) { return def; }
}
function setDB(k, v) { localStorage.setItem(k, JSON.stringify(v)); }

window.onload = function() {
    // Kiá»ƒm tra phiÃªn Ä‘Äƒng nháº­p
    const session = localStorage.getItem('snow_session');
    if (session) {
        cur = getDB(uKey(session), null);
    }
    render();

    // 1. Xá»­ lÃ½ ÄÄƒng nháº­p / ÄÄƒng kÃ½
    document.getElementById('btnLogin').onclick = function() {
        const u = document.getElementById('au').value.trim();
        const p = document.getElementById('ap').value.trim();
        if(u.length < 3) return alert("TÃªn tÃ i khoáº£n quÃ¡ ngáº¯n!");

        let user = getDB(uKey(u), null);
        if(!user) {
            // ÄÄƒng kÃ½ má»›i náº¿u chÆ°a cÃ³
            user = { username: u, password: p, balance: 0, usernameLower: u.toLowerCase() };
            alert("ÄÃ£ Ä‘Äƒng kÃ½ tÃ i khoáº£n má»›i!");
        } else if(user.password !== p) {
            return alert("Sai máº­t kháº©u!");
        }

        cur = user;
        setDB(uKey(u), cur);
        localStorage.setItem('snow_session', u);
        render();
    };

    // 2. Xá»­ lÃ½ Mua hÃ ng (FIX CHÃNH)
    document.getElementById('btnOrder').onclick = function() {
        if(!cur) return alert("Vui lÃ²ng Ä‘Äƒng nháº­p!");
        
        const gÃ³iSelected = document.getElementById('goi').value;
        const gUser = document.getElementById('g_u').value.trim();
        const gPass = document.getElementById('g_p').value.trim();

        if(!gÃ³iSelected || !gUser || !gPass) return alert("Vui lÃ²ng Ä‘iá»n Ä‘á»§ thÃ´ng tin!");

        const [tenGoi, giÃ¡] = gÃ³iSelected.split('|');
        const price = parseInt(giÃ¡);

        // Láº¥y láº¡i dá»¯ liá»‡u má»›i nháº¥t tá»« DB Ä‘á»ƒ kiá»ƒm tra tiá»n
        let dbUser = getDB(uKey(cur.username), cur);
        if(dbUser.balance < price) return alert("Báº¡n khÃ´ng Ä‘á»§ tiá»n! HÃ£y liÃªn há»‡ Admin náº¡p thÃªm.");

        // TRá»ª TIá»€N
        dbUser.balance -= price;
        cur = dbUser; // Cáº­p nháº­t biáº¿n táº¡m
        setDB(uKey(cur.username), dbUser); // LÆ°u vÃ o DB

        // LÆ¯U ÄÆ N HÃ€NG
        let orders = getDB('snow_orders', []);
        const newOrder = {
            buyer: cur.username.toLowerCase(),
            goi: tenGoi,
            acc: gUser,
            pass: gPass,
            status: "Äang chá»",
            time: new Date().toLocaleString('vi-VN')
        };
        orders.push(newOrder);
        setDB('snow_orders', orders);

        alert("âœ… Mua thÃ nh cÃ´ng! Vui lÃ²ng chá» Admin xá»­ lÃ½.");
        
        // Reset form
        document.getElementById('g_u').value = "";
        document.getElementById('g_p').value = "";
        render();
    };

    // ÄÄƒng xuáº¥t
    document.getElementById('btnLogout').onclick = function() {
        localStorage.removeItem('snow_session');
        location.reload();
    };
};

function render() {
    const auth = document.getElementById('auth_sec');
    const main = document.getElementById('main_sec');
    const uLbl = document.getElementById('u');
    const bLbl = document.getElementById('b');
    const btnOut = document.getElementById('btnLogout');
    const hisDiv = document.getElementById('his');

    if(!cur) {
        auth.style.display = "block";
        main.style.display = "none";
        btnOut.style.display = "none";
    } else {
        auth.style.display = "none";
        main.style.display = "block";
        btnOut.style.display = "block";
        
        // Cáº­p nháº­t thÃ´ng tin vÃ­
        uLbl.innerText = cur.username;
        bLbl.innerText = cur.balance.toLocaleString();

        // HIá»‚N THá»Š Lá»ŠCH Sá»¬ (FIX CHÃNH)
        const allOrders = getDB('snow_orders', []);
        const myOrders = allOrders.filter(o => o.buyer === cur.username.toLowerCase());

        if(myOrders.length === 0) {
            hisDiv.innerHTML = "<center style='color:#94a3b8;padding:10px'><i>Báº¡n chÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o.</i></center>";
        } else {
            hisDiv.innerHTML = myOrders.slice().reverse().map(o => `
                <div class="item-list">
                    <div style="display:flex; justify-content:space-between">
                        <b>${o.goi}</b>
                        <span class="status ${o.status==='ÄÃ£ xong'?'done':'wait'}">${o.status}</span>
                    </div>
                    <div style="font-size:12px; color:#64748b; margin-top:4px">
                        ${o.time} | Acc: ${o.acc}
                    </div>
                </div>
            `).join('');
        }
    }
}
</script>
</body>
</html>
