<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>‚ùÑÔ∏è SNOW SHOP ‚Äî Final Version</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        /* --- RESET & BASIC STYLE --- */
        body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f8fafc;margin:0;padding-bottom:100px; color:#334155}
        * { box-sizing: border-box; }
        
        .box{background:#fff;margin:12px;border-radius:16px;padding:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)}
        
        /* --- BUTTONS --- */
        button{border:0;padding:12px 16px;border-radius:10px;font-weight:600;margin:6px 0;cursor:pointer;transition:all 0.2s;color:#fff; display:inline-block; font-size: 14px;}
        button:hover{opacity:0.95; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
        button:active{transform: translateY(0);}
        
        button.blue{background:linear-gradient(135deg, #38bdf8, #0ea5e9)}
        button.red{background:linear-gradient(135deg, #ef4444, #dc2626)}
        button.green{background:linear-gradient(135deg, #22c55e, #16a34a)}
        button.purple{background:linear-gradient(135deg, #a855f7, #9333ea)}
        button.gray{background:#94a3b8}

        /* --- INPUTS --- */
        input,select,textarea{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:1px solid #e2e8f0;background:#f8fafc; font-size:14px; transition:0.2s}
        input:focus, select:focus{outline:none; border-color:#38bdf8; background:#fff; box-shadow: 0 0 0 3px rgba(56,189,248,0.2);}
        
        /* --- UTILS --- */
        .info{background:#f0f9ff;border:1px dashed #0ea5e9;border-radius:10px;padding:14px;margin-top:10px;line-height:1.6;font-size:14px; color:#0369a1}
        .qr-box{text-align:center;padding:20px;background:#fff;border-radius:12px; border: 2px dashed #e2e8f0; margin-top:15px}
        
        .item-list{padding:14px;border-bottom:1px solid #f1f5f9;font-size:14px; position: relative;}
        .item-list:last-child{border-bottom:none}
        
        .status-pending{color:#d97706;font-weight:bold; background:#fffbeb; padding:4px 8px; border-radius:6px; font-size:12px}
        .status-working{color:#7c3aed;font-weight:bold; background:#f3e8ff; padding:4px 8px; border-radius:6px; font-size:12px}
        .status-done{color:#16a34a;font-weight:bold; background:#dcfce7; padding:4px 8px; border-radius:6px; font-size:12px}

        /* --- MODAL SYSTEM (FIXED) --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            z-index: 9999; display: none; opacity: 0; transition: opacity 0.3s;
        }
        #modal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; pointer-events: none;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-card {
            pointer-events: auto; background: #fff; width: 90%; max-width: 400px;
            padding: 20px; border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9); opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh; overflow-y: auto;
        }
        /* Active States for Modal */
        #modal-overlay.open { display: block; opacity: 1; }
        .modal-card.open { transform: scale(1); opacity: 1; }

        /* --- ADMIN TABS --- */
        .tab-btn{padding:8px 16px; border-radius:8px; background:#f1f5f9; color:#64748b; margin-right:5px; border:none; cursor:pointer; font-size: 13px; font-weight: 600}
        .tab-btn.active{background:#0ea5e9; color:#fff; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3)}
        .admin-section{display:none; animation: fadeIn 0.3s}
        .admin-section.active{display:block}
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
        
        .flex-between { display:flex; align-items:center; justify-content:space-between; }
    </style>
</head>
<body>

<div class="box flex-between" style="background: linear-gradient(to right, #ffffff, #f0f9ff);">
    <div>
        <div style="font-size:12px; color:#64748b; margin-bottom:2px">Xin ch√†o,</div>
        <div style="font-size:16px; font-weight:bold; color:#0f172a" id="u">Kh√°ch</div>
        <div style="font-size:18px; font-weight:bold; color:#16a34a; margin-top:4px">
            üí∞ <span id="b">0</span> <small style="font-size:12px; color:#64748b">VNƒê</small>
        </div>
    </div>
    <button class="red" id="btnLogout" style="padding:8px 12px; font-size:12px; display:none">Tho√°t</button>
</div>

<div id="client_view">
    <div class="box" id="auth_section">
        <div style="text-align:center; padding:10px 0;">
            <div style="font-size:40px; margin-bottom:10px">‚ùÑÔ∏è</div>
            <h2 style="margin:0; color:#0f172a">Snow Shop</h2>
            <p style="color:#64748b; font-size:14px; margin-top:5px">H·ªá th·ªëng C√†y Thu√™ & Item Roblox Uy T√≠n</p>
        </div>
        <button id="btnShowAuth" class="blue" style="width:100%; padding:14px; font-size:16px">üîë ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</button>
    </div>

    <div class="box" id="user_actions" style="display:none">
        <button class="purple" id="btnDeposit" style="width:100%">üí≥ N·∫°p ti·ªÅn v√†o t√†i kho·∫£n</button>
    </div>

    <div class="box">
        <h3 style="margin-top:0; border-left:4px solid #0ea5e9; padding-left:10px; color:#0f172a">üõí D·ªãch v·ª•</h3>
        <select id="goi">
            <option value="">-- Vui l√≤ng ch·ªçn g√≥i --</option>
            <optgroup label="üî∞ LEVEL & FARM">
                <option value="Level 700|20000" data-info="Farm l√™n Level 700" data-detail="‚úî M·ªü Sea 2<br>‚úî Th·ªùi gian: 3‚Äì5 gi·ªù">Level 700 ‚Äì 20.000ƒë</option>
                <option value="700 ‚Üí 1500|20000" data-info="Farm max Sea 2" data-detail="‚úî M·ªü Sea 3<br>‚úî Th·ªùi gian: 1‚Äì2 ng√†y">700 ‚Üí 1500 ‚Äì 20.000ƒë</option>
                <option value="1500 ‚Üí 2800|20000" data-info="Farm max Level" data-detail="‚úî Max Level hi·ªán t·∫°i<br>‚úî Th·ªùi gian: 2‚Äì3 ng√†y">1500 ‚Üí 2800 ‚Äì 20.000ƒë</option>
                <option value="0 ‚Üí MAX|50000" data-info="C√†y t·ª´ ƒë·∫ßu t·ªõi MAX" data-detail="‚úî Full Sea 1‚Äì2‚Äì3<br>‚úî Th·ªùi gian: 4‚Äì6 ng√†y">0 ‚Üí MAX ‚Äì 50.000ƒë</option>
            </optgroup>
            <optgroup label="üéí ITEMS HOT">
                <option value="M·ªè Neo|20000" data-info="L·∫•y M·ªè Neo (Anchor)" data-detail="‚úî C·∫ßn nguy√™n li·ªáu<br>‚úî Th·ªùi gian: 1 ng√†y">M·ªè Neo ‚Äì 20.000ƒë</option>
                <option value="Tushita|15000" data-info="L·∫•y ki·∫øm Tushita" data-detail="‚úî C·∫ßn Level 2000+<br>‚úî Trong ng√†y">Tushita ‚Äì 15.000ƒë</option>
                <option value="CDK|30000" data-info="L·∫•y Cursed Dual Katana" data-detail="‚úî C·∫ßn Tushita + Yama<br>‚úî Th·ªùi gian: 1-2 ng√†y">CDK ‚Äì 30.000ƒë</option>
            </optgroup>
        </select>

        <div id="acc_box" style="display:none; animation: fadeIn 0.3s">
            <div style="margin:10px 0; font-size:13px; color:#dc2626; background:#fef2f2; padding:8px; border-radius:6px">
                <b>‚ö†Ô∏è L∆∞u √Ω:</b> Vui l√≤ng t·∫Øt x√°c minh 2 b∆∞·ªõc (2FA) ƒë·ªÉ ƒë∆°n h√†ng ƒë∆∞·ª£c x·ª≠ l√Ω nhanh nh·∫•t.
            </div>
            <input type="text" id="game_user" placeholder="T√™n ƒëƒÉng nh·∫≠p Roblox">
            <input type="text" id="game_pass" placeholder="M·∫≠t kh·∫©u Roblox">
        </div>
        
        <div id="goiInfo" class="info" style="display:none"></div>
        <button class="green" id="btnOrder" style="width:100%; margin-top:10px; font-size: 16px; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3)">X√ÅC NH·∫¨N MUA NGAY</button>
    </div>

    <div class="box">
        <h3 style="margin-top:0; border-left:4px solid #f59e0b; padding-left:10px; color:#0f172a">üìú L·ªãch s·ª≠ ƒë∆°n h√†ng</h3>
        <div id="his">ƒêang t·∫£i...</div>
    </div>
</div>

<div id="admin_view" style="display:none">
    <div class="box" style="border: 2px solid #ef4444;">
        <h2 style="color:#ef4444; margin:0 0 15px 0; font-size:18px; text-transform:uppercase; border-bottom:1px solid #eee; padding-bottom:10px">üõ† Admin Panel</h2>
        
        <div style="margin-bottom:15px; display:flex; gap:5px; overflow-x:auto; padding-bottom:5px">
            <button class="tab-btn active" data-tab="tab_orders">ƒê∆°n h√†ng</button>
            <button class="tab-btn" data-tab="tab_users">Th√†nh vi√™n</button>
            <button class="tab-btn" data-tab="tab_gift">C·ªông ti·ªÅn</button>
        </div>

        <div id="tab_orders" class="admin-section active">
            <div id="admin_all_orders"></div>
        </div>

        <div id="tab_users" class="admin-section">
            <div id="admin_user_list"></div>
        </div>

        <div id="tab_gift" class="admin-section">
            <div style="background:#fff7ed; padding:12px; border-radius:8px; margin-bottom:10px; font-size:13px; color:#c2410c; border:1px solid #ffedd5">
                Nh·∫≠p ƒë√∫ng Username ƒë·ªÉ c·ªông ti·ªÅn. User ph·∫£i ƒëƒÉng nh·∫≠p √≠t nh·∫•t 1 l·∫ßn m·ªõi c√≥ t√™n trong h·ªá th·ªëng.
            </div>
            <label style="font-size:12px; font-weight:bold; color:#64748b">T√†i kho·∫£n kh√°ch:</label>
            <input id="ad_target" placeholder="Nh·∫≠p username...">
            
            <label style="font-size:12px; font-weight:bold; color:#64748b">S·ªë ti·ªÅn:</label>
            <input type="number" id="ad_amt" placeholder="VD: 50000">
            
            <label style="font-size:12px; font-weight:bold; color:#64748b">Admin Key:</label>
            <input type="password" id="ad_key" placeholder="Nh·∫≠p m√£ b·∫£o m·∫≠t...">
            
            <button class="red" id="btnAdminAdd" style="width:100%; margin-top:10px">X√ÅC NH·∫¨N</button>
        </div>
    </div>
</div>

<div id="modal-overlay"></div>
<div id="modal-container">
    <div id="modal_content_inner" class="modal-card"></div>
</div>

<script>
/* =========================================
   1. C·∫§U H√åNH & TR·∫†NG TH√ÅI
   ========================================= */
const CONFIG = {
    ADMIN_ID: "snowadmin",
    ADMIN_PASS: "Snowadmin1910",
    ADMIN_KEY: "SNOW_SECRET",
    WEBHOOK: "https://discord.com/api/webhooks/1465766093543964673/QfBdKIbYOgo5_s9S_YaJDF6vg6ZF8RyWwEw06uPZW3YtZuPUjCmODVJfdFmowfH1d9Gm"
};

let cur = null;     // User hi·ªán t·∫°i
let allOrders = []; // Danh s√°ch ƒë∆°n
let el = {};        // Ch·ª©a c√°c element HTML

/* =========================================
   2. KH·ªûI T·∫†O (QUAN TR·ªåNG: FIX CLICK)
   ========================================= */
window.addEventListener('DOMContentLoaded', () => {
    // Ch·ªâ l·∫•y element sau khi trang ƒë√£ t·∫£i xong
    mapElements();
    
    // Load d·ªØ li·ªáu
    allOrders = safeParse('snow_orders', []);
    const session = localStorage.getItem('snow_session');
    
    if (session) {
        const uData = safeParse(userKeyFrom(session), null);
        // N·∫øu t√¨m th·∫•y user trong data, g√°n v√†o cur
        if (uData) cur = uData;
    }
    
    // G√°n s·ª± ki·ªán click
    bindEvents();
    
    // V·∫Ω giao di·ªán l·∫ßn ƒë·∫ßu
    render();
});

function mapElements() {
    el = {
        uLabel: document.getElementById('u'),
        bLabel: document.getElementById('b'),
        authSec: document.getElementById('auth_section'),
        userAct: document.getElementById('user_actions'),
        adminView: document.getElementById('admin_view'),
        his: document.getElementById('his'),
        goi: document.getElementById('goi'),
        accBox: document.getElementById('acc_box'),
        goiInfo: document.getElementById('goiInfo'),
        overlay: document.getElementById('modal-overlay'),
        modalContainer: document.getElementById('modal-container'), // Container m·ªõi
        modalCard: document.getElementById('modal_content_inner'),  // Card m·ªõi
        btnLogout: document.getElementById('btnLogout'),
        btnShowAuth: document.getElementById('btnShowAuth'),
        btnDeposit: document.getElementById('btnDeposit'),
        btnOrder: document.getElementById('btnOrder'),
        adOrders: document.getElementById('admin_all_orders'),
        adUsers: document.getElementById('admin_user_list'),
        btnAdminAdd: document.getElementById('btnAdminAdd')
    };
}

function bindEvents() {
    // C√°c s·ª± ki·ªán ch√≠nh
    if(el.btnShowAuth) el.btnShowAuth.onclick = showAuthModal;
    if(el.btnLogout) el.btnLogout.onclick = logout;
    if(el.btnDeposit) el.btnDeposit.onclick = showDepositModal;
    if(el.goi) el.goi.onchange = onPackageChange;
    if(el.btnOrder) el.btnOrder.onclick = handleOrder;
    if(el.btnAdminAdd) el.btnAdminAdd.onclick = adminAddMoney;
    
    // ƒê√≥ng modal khi click ra ngo√†i
    if(el.overlay) el.overlay.onclick = closeModal;

    // Chuy·ªÉn Tab Admin
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            
            e.target.classList.add('active');
            const targetId = e.target.getAttribute('data-tab');
            document.getElementById(targetId).classList.add('active');
        });
    });
}

/* =========================================
   3. RENDER GIAO DI·ªÜN
   ========================================= */
function render() {
    // C·∫≠p nh·∫≠t l·∫°i s·ªë d∆∞ m·ªõi nh·∫•t t·ª´ Storage (ƒë·ªÅ ph√≤ng Admin v·ª´a c·ªông ti·ªÅn)
    if (cur) {
        const fresh = safeParse(userKeyFrom(cur.username), null);
        if (fresh) cur = fresh;
    }

    if (!cur) {
        // --- CH∆ØA ƒêƒÇNG NH·∫¨P ---
        el.uLabel.innerText = "Kh√°ch";
        el.bLabel.innerText = "0";
        el.authSec.style.display = "block";
        el.userAct.style.display = "none";
        el.adminView.style.display = "none";
        el.btnLogout.style.display = "none";
        el.his.innerHTML = `
            <div style="text-align:center; padding:30px; color:#94a3b8">
                üîí<br>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠
            </div>`;
    } else {
        // --- ƒê√É ƒêƒÇNG NH·∫¨P ---
        el.uLabel.innerText = cur.username;
        el.bLabel.innerText = formatMoney(cur.balance);
        el.authSec.style.display = "none";
        el.userAct.style.display = "block";
        el.btnLogout.style.display = "block";

        // Render L·ªãch S·ª≠
        const myOrders = allOrders.filter(o => o.buyer && o.buyer.toLowerCase() === cur.usernameLower);
        if (myOrders.length === 0) {
            el.his.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8">B·∫°n ch∆∞a mua ƒë∆°n h√†ng n√†o.</div>`;
        } else {
            el.his.innerHTML = myOrders.slice().reverse().map(o => {
                let stClass = 'status-pending';
                if(o.status === 'ƒêang c√†y') stClass = 'status-working';
                if(o.status === 'ƒê√£ xong') stClass = 'status-done';
                
                return `
                <div class="item-list">
                    <div class="flex-between">
                        <span style="font-weight:600; color:#334155">üì¶ ${escapeHtml(o.goi)}</span>
                        <span class="${stClass}">${escapeHtml(o.status)}</span>
                    </div>
                    <div style="font-size:12px; color:#94a3b8; margin-top:4px">üïí ${escapeHtml(o.time)}</div>
                </div>`;
            }).join('');
        }

        // Render Admin (N·∫øu l√† Admin)
        if (cur.usernameLower === CONFIG.ADMIN_ID.toLowerCase()) {
            el.adminView.style.display = "block";
            renderAdminPanel();
        } else {
            el.adminView.style.display = "none";
        }
    }
}

function renderAdminPanel() {
    // 1. List Orders
    if (!allOrders.length) {
        el.adOrders.innerHTML = "<p style='text-align:center; color:#94a3b8'>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>";
    } else {
        // FIX: S·ª≠ d·ª•ng window.function ƒë·ªÉ g·ªçi h√†m t·ª´ HTML string
        el.adOrders.innerHTML = allOrders.slice().reverse().map((o, idx) => {
            const realIdx = allOrders.length - 1 - idx;
            return `
            <div class="item-list" style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px">
                <div class="flex-between">
                    <strong style="color:#0f172a">${escapeHtml(o.buyer)}</strong>
                    <span style="font-size:12px; color:#64748b">${escapeHtml(o.time)}</span>
                </div>
                <div style="margin:5px 0; font-size:13px; color:#334155">G√≥i: <b>${escapeHtml(o.goi)}</b></div>
                <div style="background:#f1f5f9; padding:8px; border-radius:6px; font-family:monospace; font-size:12px; color:#475569">
                    User: ${escapeHtml(o.acc)} <br> Pass: ${escapeHtml(o.pass)}
                </div>
                <div class="flex-between" style="margin-top:8px">
                    <b style="font-size:13px; color:#0ea5e9">${escapeHtml(o.status)}</b>
                    <div style="display:flex; gap:4px">
                        <button onclick="window.adminUpdate(${realIdx}, 'ƒêang c√†y')" class="purple" style="padding:5px 10px; font-size:11px; margin:0">C√†y</button>
                        <button onclick="window.adminUpdate(${realIdx}, 'ƒê√£ xong')" class="green" style="padding:5px 10px; font-size:11px; margin:0">Xong</button>
                        <button onclick="window.adminDelete(${realIdx})" class="red" style="padding:5px 10px; font-size:11px; margin:0">X√≥a</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // 2. List Users
    const userList = safeParse('snow_users', []);
    if (!userList.length) {
        el.adUsers.innerHTML = "<p style='text-align:center'>Ch∆∞a c√≥ th√†nh vi√™n.</p>";
    } else {
        el.adUsers.innerHTML = userList.map(uKey => {
            const u = safeParse(userKeyFrom(uKey), null);
            if (!u) return '';
            return `
            <div class="item-list flex-between">
                <div>
                    <div>üë§ <b>${escapeHtml(u.username)}</b></div>
                    <div style="font-size:11px; color:#94a3b8">Pass: ${escapeHtml(u.password)}</div>
                </div>
                <span style="color:#16a34a; font-weight:bold">${formatMoney(u.balance)} ƒë</span>
            </div>`;
        }).join('');
    }
}

/* =========================================
   4. LOGIC X·ª¨ L√ù (AUTH, ORDER, MODAL)
   ========================================= */

// --- Auth ---
function showAuthModal() {
    openModal(`
        <h3 style="text-align:center; margin-top:0">üîê ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h3>
        <form id="auth_form">
            <label style="font-size:12px; font-weight:bold; color:#64748b">T√†i kho·∫£n:</label>
            <input id="au" placeholder="Nh·∫≠p t√™n t√†i kho·∫£n..." autocomplete="off" required>
            
            <label style="font-size:12px; font-weight:bold; color:#64748b">M·∫≠t kh·∫©u:</label>
            <input id="ap" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." required>
            
            <button type="submit" class="blue" style="width:100%; margin-top:15px">TI·∫æP T·ª§C</button>
        </form>
        <p style="font-size:12px; color:#94a3b8; text-align:center; margin-bottom:0">
            * H·ªá th·ªëng t·ª± ƒë·ªông t·∫°o t√†i kho·∫£n m·ªõi n·∫øu ch∆∞a t·ªìn t·∫°i.
        </p>
    `);
    
    // G√°n s·ª± ki·ªán submit cho form trong modal
    setTimeout(() => {
        const form = document.getElementById('auth_form');
        const auInput = document.getElementById('au');
        if(form) {
            form.onsubmit = (e) => {
                e.preventDefault();
                handleLogin();
            };
        }
        if(auInput) auInput.focus();
    }, 100);
}

function handleLogin() {
    const uRaw = document.getElementById('au').value.trim();
    const pRaw = document.getElementById('ap').value.trim();
    
    if (uRaw.length < 3 || pRaw.length < 3) return alert("T√†i kho·∫£n v√† m·∫≠t kh·∫©u qu√° ng·∫Øn (t·ªëi thi·ªÉu 3 k√Ω t·ª±)!");
    
    const uLower = uRaw.toLowerCase();
    
    // Check Admin Hardcode
    if (uLower === CONFIG.ADMIN_ID.toLowerCase() && pRaw === CONFIG.ADMIN_PASS) {
        const adminObj = { username: CONFIG.ADMIN_ID, password: CONFIG.ADMIN_PASS, balance: 99999999, usernameLower: uLower };
        saveUser(adminObj);
        cur = adminObj;
    } else {
        // User th∆∞·ªùng
        const key = userKeyFrom(uRaw);
        const existing = safeParse(key, null);
        
        if (existing) {
            // ƒêƒÉng nh·∫≠p
            if (existing.password === pRaw) {
                cur = existing;
            } else {
                return alert("Sai m·∫≠t kh·∫©u! Vui l√≤ng ki·ªÉm tra l·∫°i.");
            }
        } else {
            // ƒêƒÉng k√Ω m·ªõi
            const newUser = { username: uRaw, password: pRaw, balance: 0, usernameLower: uLower };
            saveUser(newUser);
            cur = newUser;
        }
    }
    
    localStorage.setItem('snow_session', cur.username);
    closeModal();
    render();
}

function logout() {
    if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) return;
    localStorage.removeItem('snow_session');
    cur = null;
    render();
}

// --- Shop & Order ---
function onPackageChange() {
    const s = el.goi.options[el.goi.selectedIndex];
    if (!el.goi.value) {
        el.goiInfo.style.display = "none";
        el.accBox.style.display = "none";
        return;
    }
    el.goiInfo.style.display = "block";
    el.accBox.style.display = "block";
    el.goiInfo.innerHTML = `
        <div style="font-weight:bold; color:#0ea5e9; font-size:15px">üìå ${escapeHtml(s.dataset.info)}</div>
        <div style="color:#64748b; font-size:13px; margin-top:5px">${s.dataset.detail}</div>
    `;
}

function handleOrder() {
    if (!cur) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua h√†ng!");
    
    const val = el.goi.value;
    const uGame = document.getElementById('game_user').value.trim();
    const pGame = document.getElementById('game_pass').value.trim();
    
    if (!val) return alert("Vui l√≤ng ch·ªçn g√≥i d·ªãch v·ª•!");
    if (!uGame || !pGame) return alert("Vui l√≤ng nh·∫≠p t√†i kho·∫£n v√† m·∫≠t kh·∫©u Roblox!");
    
    const [pkgName, pkgPrice] = val.split('|');
    const cost = parseInt(pkgPrice);
    
    if (cur.balance < cost) {
        return alert(`B·∫°n kh√¥ng ƒë·ªß ti·ªÅn! C·∫ßn th√™m: ${formatMoney(cost - cur.balance)}ƒë`);
    }
    
    // Tr·ª´ ti·ªÅn
    cur.balance -= cost;
    saveUser(cur);
    
    // T·∫°o ƒë∆°n
    const newOrder = {
        buyer: cur.username,
        goi: pkgName,
        acc: uGame,
        pass: pGame,
        status: "ƒêang ch·ªù",
        time: new Date().toLocaleString('vi-VN')
    };
    
    allOrders.push(newOrder);
    localStorage.setItem('snow_orders', JSON.stringify(allOrders));
    
    // G·ª≠i Webhook
    sendDiscord(newOrder);
    
    alert("‚úÖ Mua th√†nh c√¥ng! ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.");
    
    // Reset Form
    document.getElementById('game_user').value = "";
    document.getElementById('game_pass').value = "";
    render();
}

// --- Deposit ---
function showDepositModal() {
    if(!cur) return;
    openModal(`
        <h3 style="text-align:center; margin-top:0; color:#a855f7">üí≥ N·∫°p ti·ªÅn Chuy·ªÉn kho·∫£n</h3>
        <div style="background:#fff7ed; padding:12px; border-radius:8px; border:1px solid #fdba74; text-align:center; color:#c2410c">
            N·ªôi dung chuy·ªÉn kho·∫£n b·∫Øt bu·ªôc:<br>
            <b style="font-size:18px; user-select:all">NAP ${escapeHtml(cur.username)}</b>
        </div>
        
        <div class="qr-box">
            <img src="https://img.vietqr.io/image/MB-0000000000-compact.png?amount=0&addInfo=NAP%20${encodeURIComponent(cur.username)}&accountName=SNOWSHOP" 
                 style="width:100%; max-width:200px; border-radius:8px">
            <p style="margin-bottom:0; font-size:12px; color:#64748b">Qu√©t QR ho·∫∑c chuy·ªÉn ƒë·∫øn STK Admin</p>
        </div>
        
        <button class="gray" onclick="closeModal()" style="width:100%; margin-top:10px">ƒê√≥ng</button>
    `);
}

/* =========================================
   5. ADMIN LOGIC (WINDOW GLOBAL)
   ========================================= */
// Admin c·ªông ti·ªÅn
function adminAddMoney() {
    const tName = document.getElementById('ad_target').value.trim();
    const tAmt = parseInt(document.getElementById('ad_amt').value);
    const tKey = document.getElementById('ad_key').value.trim();
    
    if (!tName) return alert("Ch∆∞a nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!");
    if (!tAmt || isNaN(tAmt)) return alert("S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!");
    if (tKey !== CONFIG.ADMIN_KEY) return alert("Sai Admin Key!");
    
    const key = userKeyFrom(tName);
    const u = safeParse(key, null);
    
    if (!u) return alert("Kh√¥ng t√¨m th·∫•y user n√†y trong h·ªá th·ªëng!");
    
    u.balance = Number(u.balance || 0) + tAmt;
    saveUser(u);
    
    // N·∫øu ƒëang login b·∫±ng nick ƒë√≥ (ho·∫∑c admin t·ª± c·ªông m√¨nh) th√¨ update lu√¥n UI
    if (cur && cur.usernameLower === u.usernameLower) {
        cur.balance = u.balance;
    }
    
    alert(`‚úÖ ƒê√£ c·ªông ${formatMoney(tAmt)}ƒë cho ${u.username}.\nS·ªë d∆∞ m·ªõi: ${formatMoney(u.balance)}ƒë`);
    render();
}

// Global functions cho Button click trong HTML String
window.adminUpdate = function(idx, status) {
    if (!allOrders[idx]) return;
    allOrders[idx].status = status;
    localStorage.setItem('snow_orders', JSON.stringify(allOrders));
    render();
}

window.adminDelete = function(idx) {
    if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n n√†y vƒ©nh vi·ªÖn?")) return;
    allOrders.splice(idx, 1);
    localStorage.setItem('snow_orders', JSON.stringify(allOrders));
    render();
}

window.closeModal = closeModal; // Expose ra ngo√†i ƒë·ªÉ g·ªçi t·ª´ n√∫t ƒê√≥ng

/* =========================================
   6. HELPER FUNCTIONS
   ========================================= */
function openModal(htmlContent) {
    if(!el.modalCard || !el.overlay) return;
    el.modalCard.innerHTML = htmlContent;
    
    // Animation fade in
    el.overlay.classList.add('open');
    el.modalContainer.style.display = 'flex'; // Hi·ªán container ƒë·ªÉ block click
    setTimeout(() => {
        el.modalCard.classList.add('open');
    }, 10);
}

function closeModal() {
    if(!el.modalCard || !el.overlay) return;
    el.modalCard.classList.remove('open');
    el.overlay.classList.remove('open');
    
    setTimeout(() => {
        el.modalContainer.style.display = 'none';
        el.modalCard.innerHTML = '';
    }, 300); // Ch·ªù animation xong m·ªõi ·∫©n
}

function saveUser(uObj) {
    const key = userKeyFrom(uObj.username);
    if (!uObj.usernameLower) uObj.usernameLower = uObj.username.trim().toLowerCase();
    
    localStorage.setItem(key, JSON.stringify(uObj));
    
    // L∆∞u v√†o index list ƒë·ªÉ hi·ªÉn th·ªã trong Admin Panel
    let list = safeParse('snow_users', []);
    if (!list.includes(uObj.usernameLower)) {
        list.push(uObj.usernameLower);
        localStorage.setItem('snow_users', JSON.stringify(list));
    }
}

function safeParse(key, defaultVal) {
    try {
        const d = localStorage.getItem(key);
        return d ? JSON.parse(d) : defaultVal;
    } catch (e) {
        console.error("JSON Error", e);
        return defaultVal;
    }
}

function userKeyFrom(name) {
    return 'user_' + (name || '').trim().toLowerCase();
}

function formatMoney(n) {
    return Number(n).toLocaleString('vi-VN');
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m];
    });
}

async function sendDiscord(o) {
    try {
        await fetch(CONFIG.WEBHOOK, {
            method: "POST", headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                embeds: [{
                    title: "üîî ƒê∆†N H√ÄNG M·ªöI",
                    color: 38143, // Blue
                    fields: [
                        {name: "Ng∆∞·ªùi mua", value: o.buyer, inline: true},
                        {name: "D·ªãch v·ª•", value: o.goi, inline: true},
                        {name: "Account", value: `\`${o.acc}\``},
                        {name: "Password", value: `\`${o.pass}\``}
                    ],
                    footer: { text: "Snow Shop System" },
                    timestamp: new Date().toISOString()
                }]
            })
        });
    } catch(e) {}
}
</script>
</body>
</html>
