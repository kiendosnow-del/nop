<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>â„ï¸ SNOW SHOP â€” Quáº£n Trá»‹ Há»‡ Thá»‘ng</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f1f5f9;margin:0;padding-bottom:50px}
        .box{background:#fff;margin:12px;border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
        button{background:#38bdf8;border:0;padding:10px 14px;border-radius:10px;font-weight:bold;margin:6px 0;cursor:pointer;transition:0.18s;color:#fff}
        button:hover{opacity:0.9}
        button.red{background:#ef4444}
        button.green{background:#22c55e}
        button.purple{background:#a855f7}
        input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
        .info{background:#f8fafc;border:1px dashed #38bdf8;border-radius:10px;padding:10px;margin-top:10px;line-height:1.6;font-size:14px}
        .qr-box{text-align:center;padding:15px;background:#f1f5f9;border-radius:10px}
        .item-list{padding:10px;border-bottom:1px solid #eee;font-size:13px; position: relative;}
        .status-pending{color:#f59e0b;font-weight:bold}
        .status-working{color:#a855f7;font-weight:bold}
        .status-done{color:#22c55e;font-weight:bold}
        /* Overlay should be under the modal; modal-card gets higher z-index */
        #modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;z-index:99;backdrop-filter: blur(2px)}
        .tab-btn{padding:8px 15px; border-radius:8px; background:#e2e8f0; color:#475569; margin-right:5px; border:none; cursor:pointer}
        .tab-btn.active{background:#38bdf8; color:#fff}
        .admin-section{display:none}
        .admin-section.active{display:block}
        /* smoother modal and ensure modal sits above overlay */
        .modal-card { transform-origin: center; transition: transform 160ms ease, opacity 160ms ease; will-change: transform, opacity; z-index:1000; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:400px; }
    </style>
</head>
<body>

<div class="box">
    ğŸ‘¤ <b id="u">Äang táº£i...</b> | ğŸ’° <b id="b">0</b>Ä‘ 
    <button class="red" id="btnLogout" style="float:right;padding:5px 10px;margin:0;display:none">ThoÃ¡t</button>
</div>

<div id="client_view">
    <div class="box" id="auth_section">
        <button id="btnShowAuth" style="width:100%; background:#6366f1">ğŸ”‘ ÄÄƒng nháº­p / ÄÄƒng kÃ½</button>
    </div>

    <div class="box" id="user_actions" style="display:none">
        <button class="purple" id="btnDeposit" style="width:100%">ğŸ’³ Náº¡p tiá»n vÃ o tÃ i khoáº£n</button>
    </div>

    <div class="box">
        <h3>ğŸ›’ Dá»‹ch vá»¥ CÃ y ThuÃª</h3>
        <select id="goi">
            <option value="">-- Chá»n gÃ³i cÃ y thuÃª --</option>
            <optgroup label="ğŸ”° LEVEL">
                <option value="Level 700|20000" data-info="Farm nhanh lÃªn level 700" data-detail="âœ” Farm quest nhanh<br>âœ” 3â€“5 giá»">Level 700 â€“ 20.000Ä‘</option>
                <option value="700 â†’ 1500|20000" data-info="Farm tá»« Sea 2" data-detail="âœ” Farm boss + quest<br>âœ” 1â€“2 ngÃ y">700 â†’ 1500 â€“ 20.000Ä‘</option>
                <option value="1500 â†’ 2800|20000" data-info="Farm Sea 3" data-detail="âœ” Farm full Sea 3<br>âœ” 2â€“3 ngÃ y">1500 â†’ 2800 â€“ 20.000Ä‘</option>
                <option value="0 â†’ MAX|50000" data-info="CÃ y tá»« Ä‘áº§u tá»›i max" data-detail="âœ” Full Sea 1â€“2â€“3<br>âœ” 4â€“6 ngÃ y">0 â†’ MAX â€“ 50.000Ä‘</option>
            </optgroup>
            <optgroup label="ğŸ’ ITEM">
                <option value="Má» Neo|20000" data-info="LÃ m Má» Neo" data-detail="âœ” Full quest<br>âœ” 1 ngÃ y">Má» Neo â€“ 20.000Ä‘</option>
                <option value="Tushita|15000" data-info="Kiáº¿m Tushita" data-detail="âœ” Trong ngÃ y">Tushita â€“ 15.000Ä‘</option>
            </optgroup>
        </select>

        <div id="acc_box" style="display:none">
            <input type="text" id="game_user" placeholder="TÃ i khoáº£n Roblox">
            <input type="text" id="game_pass" placeholder="Máº­t kháº©u Roblox">
        </div>
        <div id="goiInfo" class="info" style="display:none"></div>
        <button class="green" id="btnOrder" style="width:100%; margin-top:10px; font-size: 16px;">XÃC NHáº¬N MUA</button>
    </div>

    <div class="box">
        <h3>ğŸ“œ Lá»‹ch sá»­ cá»§a báº¡n</h3>
        <div id="his">Äang táº£i...</div>
    </div>
</div>

<div id="admin_view" style="display:none">
    <div class="box" style="border: 2px solid #ef4444;">
        <h2 style="color:#ef4444; margin:0 0 10px 0">ğŸ›  Há»† THá»NG QUáº¢N TRá»Š</h2>
        <div style="margin-bottom:10px">
            <button class="tab-btn active" data-tab="tab_orders">ÄÆ¡n hÃ ng</button>
            <button class="tab-btn" data-tab="tab_users">ThÃ nh viÃªn</button>
            <button class="tab-btn" data-tab="tab_gift">Gift/Náº¡p</button>
        </div>

        <div id="tab_orders" class="admin-section active">
            <div id="admin_all_orders"></div>
        </div>

        <div id="tab_users" class="admin-section">
            <div id="admin_user_list"></div>
        </div>

        <div id="tab_gift" class="admin-section">
            <h4>ğŸ Táº·ng tiá»n / Duyá»‡t náº¡p</h4>
            <input id="ad_target" placeholder="TÃªn tÃ i khoáº£n khÃ¡ch">
            <input type="number" id="ad_amt" placeholder="Sá»‘ tiá»n cáº§n cá»™ng">
            <input type="password" id="ad_key" placeholder="Admin Key xÃ¡c nháº­n">
            <button class="red" id="btnAdminAdd" style="width:100%">XÃC NHáº¬N Cá»˜NG TIá»€N</button>
        </div>
    </div>
</div>

<!-- removed inline onclick to avoid overlay catching clicks meant for modal -->
<div id="modal-overlay"></div>
<div id="modal_content"></div>

<script>
/* ----- Constants ----- */
const ADMIN_ID = "snowadmin";
const ADMIN_PASS = "Snowadmin1910";
const ADMIN_KEY = "SNOW_SECRET";
const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1465766093543964673/QfBdKIbYOgo5_s9S_YaJDF6vg6ZF8RyWwEw06uPZW3YtZuPUjCmODVJfdFmowfH1d9Gm";

/* ----- App state ----- */
let cur = null;
let allOrders = JSON.parse(localStorage.getItem('snow_orders') || "[]");

/* ----- Cached DOM ----- */
const el = {
    userLabel: document.getElementById('u'),
    balLabel: document.getElementById('b'),
    authSection: document.getElementById('auth_section'),
    userActions: document.getElementById('user_actions'),
    adminView: document.getElementById('admin_view'),
    his: document.getElementById('his'),
    goi: document.getElementById('goi'),
    accBox: document.getElementById('acc_box'),
    goiInfo: document.getElementById('goiInfo'),
    modalOverlay: document.getElementById('modal-overlay'),
    modalContent: document.getElementById('modal_content'),
    btnLogout: document.getElementById('btnLogout'),
    btnShowAuth: document.getElementById('btnShowAuth'),
    btnDeposit: document.getElementById('btnDeposit'),
    btnOrder: document.getElementById('btnOrder'),
    adminAllOrders: document.getElementById('admin_all_orders'),
    adminUserList: document.getElementById('admin_user_list'),
    tabBtns: document.getElementsByClassName('tab-btn'),
    btnAdminAdd: document.getElementById('btnAdminAdd'),
};

/* ----- Utilities ----- */
function userKeyFrom(name) {
    return 'user_' + name.trim().toLowerCase();
}
function saveUser(userObj) {
    // userObj must contain username (original display), password, balance
    const key = userKeyFrom(userObj.username);
    // store canonical usernameLower inside object for easier lookup
    const stored = {
        username: userObj.username,        // display name (original)
        usernameLower: userObj.username.trim().toLowerCase(),
        password: userObj.password,
        balance: Number(userObj.balance) || 0
    };
    localStorage.setItem(key, JSON.stringify(stored));
    // maintain index of users for faster admin rendering
    let idx = JSON.parse(localStorage.getItem('snow_users') || "[]");
    if (!idx.includes(stored.usernameLower)) {
        idx.push(stored.usernameLower);
        localStorage.setItem('snow_users', JSON.stringify(idx));
    }
    return stored;
}
function loadUserFromStorageByKey(key) {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
}

/* ----- Initialization ----- */
window.addEventListener('DOMContentLoaded', () => {
    const session = localStorage.getItem('snow_session');
    if (session) {
        const data = loadUserFromStorageByKey(userKeyFrom(session));
        if (data) cur = data;
    }
    bindUI();
    render();
});

/* ----- UI Bindings ----- */
function bindUI() {
    // show auth modal
    el.btnShowAuth.addEventListener('click', showAuth);
    el.btnLogout.addEventListener('click', logout);
    el.btnDeposit.addEventListener('click', showDeposit);
    el.goi.addEventListener('change', showInfo);
    el.btnOrder.addEventListener('click', order);

    // tab switching
    Array.from(el.tabBtns).forEach(btn => {
        btn.addEventListener('click', (e) => {
            const tabId = btn.getAttribute('data-tab');
            openTab(tabId, btn);
        });
    });

    // admin add money
    const btnAdmin = document.getElementById('btnAdminAdd');
    if (btnAdmin) {
        btnAdmin.addEventListener('click', adminAddMoney);
    }

    // IMPORTANT: only close modal when clicking directly on overlay (not when clicking inside modal)
    el.modalOverlay.addEventListener('click', (e) => {
        if (e.target === el.modalOverlay) closeModal();
    });
}

/* ----- Render ----- */
function render() {
    if (!cur) {
        el.userLabel.innerText = "KhÃ¡ch";
        el.balLabel.innerText = "0";
        el.authSection.style.display = "block";
        el.userActions.style.display = "none";
        el.adminView.style.display = "none";
        el.btnLogout.style.display = "none";
        renderHistory([]);
        return;
    }

    el.userLabel.innerText = cur.username; // display name
    el.balLabel.innerText = Number(cur.balance).toLocaleString();
    el.authSection.style.display = "none";
    el.userActions.style.display = "block";
    el.btnLogout.style.display = "inline-block";

    // personal history
    const myOrders = allOrders.filter(o => o.buyer && o.buyer.toLowerCase() === cur.usernameLower);
    renderHistory(myOrders);

    // admin?
    if (cur.usernameLower === ADMIN_ID.toLowerCase()) {
        el.adminView.style.display = "block";
        renderAdminData();
    } else {
        el.adminView.style.display = "none";
    }
}

function renderHistory(myOrders) {
    if (!myOrders || myOrders.length === 0) {
        el.his.innerHTML = "<i>ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng.</i>";
        return;
    }
    // build html once
    const lines = myOrders.slice().reverse().map(o => {
        let cls = o.status === 'ÄÃ£ xong' ? 'status-done' : (o.status === 'Äang cÃ y' ? 'status-working' : 'status-pending');
        return `<div class="item-list"><b>${escapeHtml(o.goi)}</b> - <span class="${cls}">${escapeHtml(o.status)}</span><br><small>${escapeHtml(o.time)}</small></div>`;
    });
    el.his.innerHTML = lines.join('');
}

function renderAdminData() {
    // orders
    if (!allOrders || allOrders.length === 0) {
        el.adminAllOrders.innerHTML = "ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o.";
    } else {
        const html = allOrders.slice().reverse().map((o, idx) => {
            const originalIdx = allOrders.length - 1 - idx;
            return `<div class="item-list">
                <b>${escapeHtml(o.buyer)}</b>: ${escapeHtml(o.goi)} <br>
                <code>User: ${escapeHtml(o.acc)}</code> | <code>Pass: ${escapeHtml(o.pass)}</code> <br>
                TT: <b>${escapeHtml(o.status)}</b> <br>
                <button data-idx="${originalIdx}" data-st="Äang cÃ y" class="btn-mini purple" style="padding:4px 8px; font-size:11px">Äang cÃ y</button>
                <button data-idx="${originalIdx}" data-st="ÄÃ£ xong" class="btn-mini green" style="padding:4px 8px; font-size:11px">Xong</button>
                <button data-idx="${originalIdx}" class="btn-mini red" style="padding:4px 8px; font-size:11px">XÃ³a</button>
            </div>`;
        }).join('');
        el.adminAllOrders.innerHTML = html;
        // delegate buttons
        Array.from(el.adminAllOrders.querySelectorAll('.btn-mini')).forEach(b => {
            b.addEventListener('click', (ev) => {
                const idx = parseInt(b.getAttribute('data-idx'));
                const st = b.getAttribute('data-st');
                if (b.classList.contains('red')) return delOrder(idx);
                if (st) return upSt(idx, st);
            });
        });
    }

    // users - use snow_users index
    const idx = JSON.parse(localStorage.getItem('snow_users') || "[]");
    if (!idx || idx.length === 0) {
        el.adminUserList.innerHTML = "<i>ChÆ°a cÃ³ thÃ nh viÃªn.</i>";
    } else {
        const lines = idx.map(nameLower => {
            const u = loadUserFromStorageByKey(userKeyFrom(nameLower));
            if (!u) return '';
            return `<div class="item-list">ğŸ‘¤ <b>${escapeHtml(u.username)}</b> | ğŸ’° ${Number(u.balance).toLocaleString()}Ä‘</div>`;
        }).filter(Boolean);
        el.adminUserList.innerHTML = lines.join('') || "<i>KhÃ´ng tÃ¬m tháº¥y user.</i>";
    }
}

/* ----- Actions ----- */

function showAuth() {
    openModal(buildAuthModalHtml());
    // attach listeners after modal inserted
    const form = document.getElementById('auth_form');
    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            handleAuth();
        });
    }
}

function buildAuthModalHtml() {
    return `
    <div class="box modal-card" style="border:2px solid #38bdf8">
        <h3>ğŸ” ÄÄƒng nháº­p / ÄÄƒng kÃ½</h3>
        <form id="auth_form">
            <input id="au" name="au" placeholder="TÃªn tÃ i khoáº£n..." autocomplete="username" required>
            <input id="ap" name="ap" type="password" placeholder="Máº­t kháº©u..." autocomplete="current-password" required>
            <button type="submit" style="width:100%; background:#6366f1">XÃC NHáº¬N</button>
            <p style="font-size:11px; color:gray">* Náº¿u chÆ°a cÃ³ tÃ i khoáº£n, há»‡ thá»‘ng sáº½ tá»± táº¡o má»›i.</p>
        </form>
        <button class="red" type="button" onclick="closeModal()" style="width:100%">ÄÃ“NG</button>
    </div>`;
}

function handleAuth() {
    const auEl = document.getElementById('au');
    const apEl = document.getElementById('ap');
    const usernameRaw = auEl.value.trim();
    const password = apEl.value.trim();
    if (usernameRaw.length < 3 || password.length < 3) return alert("TÃ i khoáº£n/Máº­t kháº©u pháº£i tá»« 3 kÃ½ tá»±!");

    const usernameLower = usernameRaw.toLowerCase();

    // Admin shortcut
    if (usernameLower === ADMIN_ID.toLowerCase() && password === ADMIN_PASS) {
        const adminObj = { username: ADMIN_ID, password: ADMIN_PASS, balance: 88888888, usernameLower: ADMIN_ID.toLowerCase() };
        saveUser(adminObj);
        cur = adminObj;
    } else {
        const key = userKeyFrom(usernameRaw);
        const existing = loadUserFromStorageByKey(key);
        if (existing) {
            if (existing.password === password) {
                cur = existing;
            } else {
                return alert("Sai máº­t kháº©u!");
            }
        } else {
            // create new
            const newUser = { username: usernameRaw, password: password, balance: 0 };
            const stored = saveUser(newUser);
            cur = stored;
        }
    }

    // persist session and in-memory
    localStorage.setItem('snow_session', cur.username);
    closeModal();
    render();
}

function logout() {
    localStorage.removeItem('snow_session');
    cur = null;
    // small delay to show action
    setTimeout(() => { render(); }, 50);
}

function showDeposit() {
    if (!cur) return alert("Vui lÃ²ng Ä‘Äƒng nháº­p!");
    openModal(`
        <div class="box modal-card" style="border:2px solid #38bdf8">
            <h3>ğŸ’³ Náº¡p tiá»n qua NgÃ¢n hÃ ng</h3>
            <p>Vui lÃ²ng chuyá»ƒn khoáº£n Ä‘Ãºng ná»™i dung bÃªn dÆ°á»›i:</p>
            <div style="background:#fff3cd; padding:10px; border-radius:8px; margin-bottom:10px">
                Ná»™i dung: <b>NAP ${escapeHtml(cur.username)}</b>
            </div>
            <div class="qr-box">
                <img src="https://img.vietqr.io/image/TCB-1373727384-compact.png?addTag=NAP%20${encodeURIComponent(cur.username)}" style="width:200px; border:1px solid #ddd">
                <p><small>Há»‡ thá»‘ng sáº½ cá»™ng tiá»n sau 1-5 phÃºt.</small></p>
            </div>
            <button class="red" type="button" onclick="closeModal()" style="width:100%">ÄÃ“NG</button>
        </div>
    `);
}

function showInfo(){
    let s = el.goi.options[el.goi.selectedIndex];
    if(!s.value) {
        el.goiInfo.style.display="none";
        el.accBox.style.display="none";
        return;
    }
    el.goiInfo.style.display="block";
    el.accBox.style.display="block";
    el.goiInfo.innerHTML = `<b>ğŸ“Œ ${escapeHtml(s.dataset.info)}</b><br><small>${s.dataset.detail}</small>`;
}

function order() {
    if(!cur) return alert("Vui lÃ²ng Ä‘Äƒng nháº­p!");
    const s = el.goi;
    const u = document.getElementById('game_user').value.trim();
    const p = document.getElementById('game_pass').value.trim();

    if(!s.value || !u || !p) return alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!");

    const [name, price] = s.value.split('|');
    const cost = parseInt(price);

    if (Number(cur.balance) < cost) return alert("Báº¡n khÃ´ng Ä‘á»§ tiá»n! Vui lÃ²ng náº¡p thÃªm.");

    cur.balance = Number(cur.balance) - cost;
    // persist user
    saveUser(cur);

    const newOrder = {
        buyer: cur.username, 
        goi: name, 
        acc: u, 
        pass: p,
        status: "Äang chá»", 
        time: new Date().toLocaleString()
    };

    allOrders.push(newOrder);
    localStorage.setItem('snow_orders', JSON.stringify(allOrders));

    sendDiscordNotify(newOrder);
    render();
    alert("Mua thÃ nh cÃ´ng! Há»‡ thá»‘ng Ä‘ang xá»­ lÃ½.");
}

function adminAddMoney() {
    const targetRaw = document.getElementById('ad_target').value.trim();
    const targetKey = userKeyFrom(targetRaw);
    const amt = parseInt(document.getElementById('ad_amt').value);
    const key = document.getElementById('ad_key').value;

    if (!targetRaw) return alert("Nháº­p tÃªn tÃ i khoáº£n cáº§n cá»™ng tiá»n!");
    if (isNaN(amt)) return alert("Sá»‘ tiá»n khÃ´ng há»£p lá»‡!");

    if (key !== ADMIN_KEY) return alert("Sai mÃ£ Admin Key!");

    const data = loadUserFromStorageByKey(targetKey);
    if (!data) return alert("KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng nÃ y!");

    data.balance = Number(data.balance || 0) + Number(amt);
    // save
    localStorage.setItem(targetKey, JSON.stringify(data));
    // ensure index contains it
    let idx = JSON.parse(localStorage.getItem('snow_users') || "[]");
    if (!idx.includes(data.usernameLower)) {
        idx.push(data.usernameLower);
        localStorage.setItem('snow_users', JSON.stringify(idx));
    }

    alert(`ÄÃ£ cá»™ng ${amt}Ä‘ cho ${data.username}`);
    render();
}

/* ----- Admin order helpers ----- */
function upSt(i, s) {
    if (!allOrders[i]) return;
    allOrders[i].status = s;
    localStorage.setItem('snow_orders', JSON.stringify(allOrders));
    render();
}

function delOrder(i) {
    if (!allOrders[i]) return;
    if (!confirm("XÃ³a Ä‘Æ¡n nÃ y?")) return;
    allOrders.splice(i, 1);
    localStorage.setItem('snow_orders', JSON.stringify(allOrders));
    render();
}

/* ----- Modal helpers ----- */
function openModal(html) {
    el.modalContent.innerHTML = html;
    el.modalOverlay.style.display = "block";
}
function closeModal() {
    el.modalOverlay.style.display = "none";
    el.modalContent.innerHTML = "";
}

/* ----- Misc ----- */
async function sendDiscordNotify(orderData) {
    try {
        const params = {
            embeds: [{
                title: "ğŸ”” CÃ“ ÄÆ N HÃ€NG Má»šI!",
                color: 5814783,
                fields: [
                    { name: "ğŸ‘¤ KhÃ¡ch hÃ ng", value: orderData.buyer, inline: true },
                  
