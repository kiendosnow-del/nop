<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SNOW SHOP â€” ThuÃª cÃ y Blox Fruits (Pro)</title>

<!-- Font -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#04101b; --panel:#071326; --card:#0d1a2a; --muted:#9aa3af; --text:#e6eef6;
  --accent:#06b6d4; --accent-2:#60a5fa; --success:#10b981; --danger:#ef4444;
  --glass: rgba(255,255,255,0.02); --radius:12px; --shadow: 0 12px 34px rgba(2,6,23,0.6);
  --max-w:1200px; --gap:14px; --tran:200ms;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:linear-gradient(180deg,#03101a,#041426);color:var(--text);
  -webkit-font-smoothing:antialiased;
}

/* Layout */
.container{max-width:var(--max-w);margin:18px auto;padding:12px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:54px;height:54px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#2563eb);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021022}
.title{font-weight:700}
.header-meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:14px}

/* Nav */
.nav{display:flex;gap:8px;justify-content:center;margin-bottom:14px}
.nav button{background:transparent;border:0;color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:all var(--tran)}
.nav button[aria-current="true"], .nav button:hover{color:var(--text);background:var(--glass)}

/* Main grid */
.main{display:grid;grid-template-columns:1fr 360px;gap:18px}
@media (max-width:980px){ .main{grid-template-columns:1fr} }

.panel{background:linear-gradient(180deg,var(--panel),#061426);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}

/* Hero + controls */
.hero{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,rgba(6,182,212,0.05),rgba(58,123,213,0.03))}
.hero h1{margin:0;font-size:20px}
.controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.controls input, .controls select{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:10px;border-radius:10px;width:100%}
.controls .col{flex:1;min-width:160px}

/* Packages grid */
.grid{margin-top:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap)}
@media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
@media (max-width:640px){ .grid{grid-template-columns:1fr} }

.card-item{padding:14px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.014),transparent);border:1px solid rgba(255,255,255,0.03);transition:transform var(--tran),box-shadow var(--tran)}
.card-item:hover{transform:translateY(-6px);box-shadow:0 18px 36px rgba(0,0,0,0.6)}
.pkg-head{display:flex;justify-content:space-between;align-items:center}
.pkg-name{font-weight:800}
.pkg-price{font-weight:800;color:var(--accent)}
.pkg-desc{color:var(--muted);margin-top:8px;font-size:13px}
.features{margin-top:10px;color:var(--muted);font-size:13px}
.feature{display:flex;gap:8px;align-items:flex-start;margin-bottom:6px}
.feature .dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent-2));margin-top:6px}

/* actions */
.row-actions{display:flex;gap:8px;margin-top:12px}
.btn{border:0;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;color:#021022;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:transform var(--tran)}
.btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04)}
.btn:active{transform:translateY(1px)}

/* Sidebar pieces */
.sidebar{display:flex;flex-direction:column;gap:12px}
.wallet .balance{font-weight:800;color:var(--accent);font-size:18px;margin-top:8px}
.orders-preview .order-small{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--glass);margin-bottom:8px}

/* admin */
.admin-badge{background:linear-gradient(90deg,#facc15,#eab308);color:#021022;padding:6px 8px;border-radius:999px;font-weight:700}

/* modal/toast */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:100%;max-width:760px;background:linear-gradient(180deg,#071022,#05101a);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:70}
.kv{color:var(--muted);font-size:13px}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden>SS</div>
      <div>
        <div class="title">SNOW SHOP</div>
        <div class="kv">ThuÃª cÃ y Blox Fruits â€” Cao cáº¥p â€¢ Uy tÃ­n â€¢ Báº£o máº­t</div>
      </div>
    </div>

    <div class="header-meta" aria-hidden>
      <div>ğŸ‘¤ <strong id="hdr-user">ChÆ°a Ä‘Äƒng nháº­p</strong> <span id="hdr-admin" class="admin-badge hidden">ADMIN</span></div>
      <div>ğŸ’° <strong id="hdr-balance">0Ä‘</strong></div>
    </div>
  </header>

  <nav class="nav" role="navigation">
    <button data-tab="packages" aria-current="true">GÃ³i dá»‹ch vá»¥</button>
    <button data-tab="account">TÃ i khoáº£n</button>
    <button data-tab="orders">Lá»‹ch sá»­</button>
    <button id="nav-deposit">Náº¡p bank</button>
    <button id="contactBtn">LiÃªn há»‡</button>
  </nav>

  <main class="main">
    <!-- left -->
    <section class="panel" id="leftPanel">
      <div class="hero">
        <div>
          <h1>ThuÃª cÃ y chuyÃªn nghiá»‡p â€” An toÃ n & Nhanh</h1>
          <p class="kv">Chá»n gÃ³i theo nhu cáº§u. Thanh toÃ¡n báº±ng vÃ­ (sá»‘ dÆ°) hoáº·c náº¡p bank. Admin cÃ³ quyá»n gift & duyá»‡t náº¡p.</p>
          <div style="margin-top:10px">
            <button class="btn" id="cta-order">Mua ngay</button>
            <button class="btn secondary" id="cta-learn">CÃ¡ch hoáº¡t Ä‘á»™ng</button>
          </div>
        </div>
        <div style="text-align:right">
          <div class="kv">Há»— trá»£ 24/7</div>
          <div style="margin-top:10px" class="kv">Cam káº¿t hoÃ n tiá»n náº¿u vi pháº¡m</div>
        </div>
      </div>

      <div class="controls" style="margin-top:12px">
        <div class="col" style="flex:2">
          <input id="searchInput" placeholder="TÃ¬m kiáº¿m gÃ³i (vÃ­ dá»¥: Tushita, Level,...)" />
        </div>

        <div class="col" style="min-width:220px">
          <select id="goi" aria-label="Chá»n gÃ³i">
            <option value="">-- Chá»n gÃ³i cÃ y thuÃª --</option>

            <optgroup label="ğŸ”° LEVEL">
            <option value="Level 700|20000"
            data-info="Farm nhanh lÃªn level 700"
            data-detail="âœ” Farm quest nhanh
âœ” KhÃ´ng Ä‘á»•i trÃ¡i
âœ” 3â€“5 giá»">
            Level 700 â€“ 20.000Ä‘</option>

            <option value="700 â†’ 1500|20000"
            data-info="Farm tá»« Sea 2"
            data-detail="âœ” Farm boss + quest
âœ” KhÃ´ng máº¥t Ä‘á»“
âœ” 1â€“2 ngÃ y">
            700 â†’ 1500 â€“ 20.000Ä‘</option>

            <option value="1500 â†’ 2800|20000"
            data-info="Farm Sea 3"
            data-detail="âœ” Farm full Sea 3
âœ” An toÃ n 100%
âœ” 2â€“3 ngÃ y">
            1500 â†’ 2800 â€“ 20.000Ä‘</option>

            <option value="0 â†’ MAX|50000"
            data-info="CÃ y tá»« Ä‘áº§u tá»›i max"
            data-detail="âœ” Full Sea 1â€“2â€“3
âœ” KhÃ´ng máº¥t acc
âœ” 4â€“6 ngÃ y">
            0 â†’ MAX â€“ 50.000Ä‘</option>
            </optgroup>

            <optgroup label="ğŸ’ ITEM">
            <option value="Má» Neo|20000"
            data-info="LÃ m Má» Neo"
            data-detail="âœ” Full quest
âœ” KhÃ´ng máº¥t Ä‘á»“
âœ” 1 ngÃ y">
            Má» Neo â€“ 20.000Ä‘</option>

            <option value="Tushita|15000"
            data-info="Kiáº¿m Tushita"
            data-detail="âœ” Full quest
âœ” An toÃ n
âœ” Trong ngÃ y">
            Tushita â€“ 15.000Ä‘</option>

            <option value="Yama|30000"
            data-info="Kiáº¿m Yama"
            data-detail="âœ” Full Yama
âœ” KhÃ´ng máº¥t Ä‘á»“
âœ” 1â€“2 ngÃ y">
            Yama â€“ 30.000Ä‘</option>

            <option value="Tam Kiáº¿m Full|35000"
            data-info="True Triple Katana"
            data-detail="âœ” Full 3 kiáº¿m
âœ” KhÃ´ng rollback
âœ” 2â€“3 ngÃ y">
            Tam Kiáº¿m Full â€“ 35.000Ä‘</option>

            <option value="CDK|30000"
            data-info="Cursed Dual Katana"
            data-detail="âœ” Full CDK
âœ” KhÃ´ng máº¥t item
âœ” 1â€“2 ngÃ y">
            CDK â€“ 30.000Ä‘</option>
            </optgroup>

            <optgroup label="ğŸ’  V4">
            <option value="Full Gear V4|30000"
            data-info="Full Gear V4"
            data-detail="âœ” Full Gear
âœ” Thá»©c tá»‰nh V4
âœ” 1â€“2 ngÃ y">
            Full Gear V4 â€“ 30.000Ä‘</option>

            <option value="1 Gear V4|5000"
            data-info="Up 1 Gear"
            data-detail="âœ” 1 Gear báº¥t ká»³
âœ” Nhanh gá»n
âœ” Trong ngÃ y">
            1 Gear V4 â€“ 5.000Ä‘</option>
            </optgroup>

            <optgroup label="ğŸ¥‹ MELEE">
            <option value="Godhuman|20000"
            data-info="Melee Godhuman"
            data-detail="âœ” Full Godhuman
âœ” Farm nguyÃªn liá»‡u
âœ” 1 ngÃ y">
            Godhuman â€“ 20.000Ä‘</option>

            <option value="Melee V2|15000"
            data-info="Up Melee V2"
            data-detail="âœ” Melee V2
âœ” Nhanh
âœ” Trong ngÃ y">
            Melee V2 â€“ 15.000Ä‘</option>
            </optgroup>
          </select>
        </div>

        <div style="min-width:140px">
          <select id="sortSelect" aria-label="Sáº¯p xáº¿p">
            <option value="default">Máº·c Ä‘á»‹nh</option>
            <option value="price_asc">GiÃ¡ tÄƒng dáº§n</option>
            <option value="price_desc">GiÃ¡ giáº£m dáº§n</option>
          </select>
        </div>
      </div>

      <div id="packagesGrid" class="grid" aria-live="polite"></div>
    </section>

    <!-- right -->
    <aside class="sidebar">
      <div class="panel wallet">
        <div class="kv">TÃ i khoáº£n</div>
        <div id="acctName" class="kv" style="margin-top:6px">Báº¡n chÆ°a Ä‘Äƒng nháº­p</div>
        <div id="balance" class="balance">0Ä‘</div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="openAccount">ÄÄƒng nháº­p / ÄÄƒng kÃ½</button>
          <button class="btn secondary" id="quickBuy">Äáº·t nhanh</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn secondary" id="openDeposit">Náº¡p bank</button>
        </div>
      </div>

      <div class="panel orders-preview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>ÄÆ¡n gáº§n Ä‘Ã¢y</strong>
          <button class="small" id="viewOrders">Xem táº¥t cáº£</button>
        </div>
        <div id="ordersPreview" style="margin-top:12px"></div>
      </div>

      <div id="adminPanelPlaceholder" class="panel hidden">
        <strong>Admin</strong>
        <div style="margin-top:8px">
          <button class="btn" id="openAdminPanel">Báº£ng quáº£n trá»‹</button>
        </div>
      </div>

      <div class="panel">
        <strong>Há»— trá»£</strong>
        <div class="kv" style="margin-top:8px">Discord / Telegram / Zalo â€” cáº­p nháº­t</div>
        <div style="margin-top:12px"><button class="btn secondary" id="contactSupport">Má»Ÿ kÃªnh há»— trá»£</button></div>
      </div>
    </aside>
  </main>
</div>

<!-- modal + toast root -->
<div id="modalRoot" class="hidden" aria-hidden="true"></div>
<div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* ====================================================================================
   SNOW SHOP â€” Production-ready single-file frontend (client-side fallback)
   Changes made:
   - Fixed existing JS bugs (syntax errors, incomplete functions).
   - Added a real-mode / API layer: configure API_BASE to enable server-backed actions.
   - If no API configured, the app falls back to secure localStorage for demo/testing,
     but everything is structured to call server endpoints for auth/orders/deposits.
   - Added the user-provided <select id="goi"> package selector and wired it to UI.
   - Improved rendering, validation, and error handling.
   - Kept forwarding placeholder for webhooks but moved to config.
   IMPORTANT: To make this a "real" deployment, set API_BASE to your backend URL and
   implement the expected endpoints (see API_* constants and expected request/response shapes).
   ==================================================================================== */

/* CONFIG - set API_BASE to your backend URL for "real" behavior (e.g. "https://api.myshop.example") */
const CONFIG = {
  API_BASE: "", // <-- PUT YOUR BACKEND BASE URL HERE to enable server mode
  ENDPOINTS: {
    login: "/auth/login",            // POST {username,password} -> {token,user:{username,balance,roles}}
    register: "/auth/register",      // POST {username,password} -> {ok:true}
    me: "/auth/me",                  // GET (with token) -> {user}
    orders: "/orders",               // GET/POST
    deposits: "/deposits",           // GET/POST/PATCH (admin)
    users_admin: "/admin/users",     // admin-only endpoints
  },
  DISCORD_WEBHOOK: "" // webhook or backend forwarding endpoint (do NOT put raw webhook publicly)
};

/* PACKAGES: make sure they match the <select id="goi"> options */
const PACKAGES = [
  { id:'level_700', name:'Level 700', price:20000, group:'LEVEL', desc:'Farm nhanh lÃªn level 700', detail:'âœ” Farm quest nhanh\nâœ” KhÃ´ng Ä‘á»•i trÃ¡i\nâœ” 3â€“5 giá»', time:'3â€“5 giá»' },
  { id:'700_1500', name:'700 â†’ 1500', price:20000, group:'LEVEL', desc:'Farm tá»« Sea 2', detail:'âœ” Farm boss + quest\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },
  { id:'1500_2800', name:'1500 â†’ 2800', price:20000, group:'LEVEL', desc:'Farm Sea 3', detail:'âœ” Farm full Sea 3\nâœ” An toÃ n 100%\nâœ” 2â€“3 ngÃ y', time:'2â€“3 ngÃ y' },
  { id:'0_max', name:'0 â†’ MAX', price:50000, group:'LEVEL', desc:'CÃ y tá»« Ä‘áº§u tá»›i max', detail:'âœ” Full Sea 1â€“2â€“3\nâœ” KhÃ´ng máº¥t acc\nâœ” 4â€“6 ngÃ y', time:'4â€“6 ngÃ y' },

  { id:'mo_neo', name:'Má» Neo', price:20000, group:'ITEM', desc:'LÃ m Má» Neo', detail:'âœ” Full quest\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1 ngÃ y', time:'1 ngÃ y' },
  { id:'tushita', name:'Tushita', price:15000, group:'ITEM', desc:'Kiáº¿m Tushita', detail:'âœ” Full quest\nâœ” An toÃ n\nâœ” Trong ngÃ y', time:'Trong ngÃ y' },
  { id:'yama', name:'Yama', price:30000, group:'ITEM', desc:'Kiáº¿m Yama', detail:'âœ” Full Yama\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },
  { id:'tam_kiem', name:'Tam Kiáº¿m Full', price:35000, group:'ITEM', desc:'True Triple Katana', detail:'âœ” Full 3 kiáº¿m\nâœ” KhÃ´ng rollback\nâœ” 2â€“3 ngÃ y', time:'2â€“3 ngÃ y' },
  { id:'cdk', name:'CDK', price:30000, group:'ITEM', desc:'Cursed Dual Katana', detail:'âœ” Full CDK\nâœ” KhÃ´ng máº¥t item\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },

  { id:'full_v4', name:'Full Gear V4', price:30000, group:'V4', desc:'Full Gear V4', detail:'âœ” Full Gear\nâœ” Thï¿½ï¿½c tá»‰nh V4\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },
  { id:'one_v4', name:'1 Gear V4', price:5000, group:'V4', desc:'Up 1 Gear', detail:'âœ” 1 Gear báº¥t ká»³\nâœ” Nhanh gá»n\nâœ” Trong ngÃ y', time:'Trong ngÃ y' },

  { id:'godhuman', name:'Godhuman', price:20000, group:'MELEE', desc:'Melee Godhuman', detail:'âœ” Full Godhuman\nâœ” Farm nguyÃªn liá»‡u\nâœ” 1 ngÃ y', time:'1 ngÃ y' },
  { id:'melee_v2', name:'Melee V2', price:15000, group:'MELEE', desc:'Up Melee V2', detail:'âœ” Melee V2\nâœ” Nhanh\nâœ” Trong ngÃ y', time:'Trong ngÃ y' }
];

/* Small helpers */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => (Number(n)||0).toLocaleString('vi-VN');
const now = () => Date.now();
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn, wait=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); } }

/* Simple in-browser "auth token" storage for server mode */
function setAuthToken(t){ if(!t) sessionStorage.removeItem('snow_token'); else sessionStorage.setItem('snow_token', t); }
function getAuthToken(){ return sessionStorage.getItem('snow_token'); }

/* ---------- Backend abstraction ----------
   The app is built to call a backend if CONFIG.API_BASE is set.
   If not set, the app falls back to localStorage-based Storage for convenience/testing.
   Implement these endpoints on your server for a "real" deployment.
-------------------------------------------*/

/* Local fallback storage (kept for testing, but not the recommended production mode) */
const Storage = {
  usersKey: 'snow_users_v5',
  ordersKey: 'snow_orders_v5',
  depositsKey: 'snow_deposits_v5',
  logsKey: 'snow_logs_v5',
  getUsers(){ try{return JSON.parse(localStorage.getItem(this.usersKey)||'{}')}catch(e){return{}} },
  saveUsers(v){ localStorage.setItem(this.usersKey, JSON.stringify(v)) },
  getOrders(){ try{return JSON.parse(localStorage.getItem(this.ordersKey)||'[]')}catch(e){return[]} },
  saveOrders(v){ localStorage.setItem(this.ordersKey, JSON.stringify(v)) },
  getDeposits(){ try{return JSON.parse(localStorage.getItem(this.depositsKey)||'[]')}catch(e){return[]} },
  saveDeposits(v){ localStorage.setItem(this.depositsKey, JSON.stringify(v)) },
  pushLog(entry){ const l = JSON.parse(localStorage.getItem(this.logsKey)||'[]'); l.unshift(entry); localStorage.setItem(this.logsKey, JSON.stringify(l)); }
};

/* Minimal crypto helper for demo registration/login (only used in fallback mode) */
async function sha256(msg){ const enc = new TextEncoder(); const buf = await crypto.subtle.digest('SHA-256', enc.encode(msg)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

/* Toast + modal */
const toastWrap = document.getElementById('toastWrap');
function toast(msg, {type='info', timeout=3000}={}) {
  const el = document.createElement('div');
  el.className = 'panel';
  el.style.padding='10px';
  el.style.minWidth='200px';
  el.style.borderRadius='8px';
  el.style.background = type==='error' ? 'linear-gradient(180deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02))' : 'linear-gradient(180deg, rgba(6,182,212,0.04), transparent)';
  el.textContent = msg;
  toastWrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateX(12px)'; setTimeout(()=>el.remove(),300); }, timeout);
}
const modalRoot = document.getElementById('modalRoot');
function showModal(contentHTML, {onOpen=null}={}) {
  modalRoot.innerHTML = `<div class="modal-backdrop" id="modalBackdrop">${contentHTML}</div>`;
  modalRoot.classList.remove('hidden');
  requestAnimationFrame(()=> {
    const focusable = modalRoot.querySelector('button, input, textarea, [tabindex]:not([tabindex="-1"])');
    if(focusable) focusable.focus();
    if(onOpen) onOpen();
  });
  function onKey(e){ if(e.key==='Escape') hideModal(); }
  document.addEventListener('keydown', onKey);
  modalRoot._onKey = onKey;
}
function hideModal(){ modalRoot.innerHTML=''; modalRoot.classList.add('hidden'); if(modalRoot._onKey) document.removeEventListener('keydown', modalRoot._onKey); }

/* ---------- "Server" calls with fallback ---------- */
async function apiFetch(path, opts={}) {
  const base = CONFIG.API_BASE && CONFIG.API_BASE.trim();
  if(!base){
    // No backend configured -> fallback error; let callers handle fallback logic
    const err = new Error('NO_API');
    err.code = 'NO_API';
    throw err;
  }
  const url = base.replace(/\/+$/,'') + path;
  const headers = Object.assign({}, opts.headers || {});
  const token = getAuthToken();
  if(token) headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(url, Object.assign({}, opts, { headers }));
  if(!res.ok){
    const text = await res.text();
    const e = new Error('API_ERROR: ' + res.status + ' ' + text);
    e.status = res.status;
    e.body = text;
    throw e;
  }
  return res.json().catch(()=>null);
}

/* Auth + user management functions.
   In server mode these call API endpoints; otherwise they operate on local storage.
*/
async function registerUser(username, password){
  if(!username || !password) throw new Error('Nháº­p tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u');
  if(CONFIG.API_BASE){
    // server mode
    return apiFetch(CONFIG.ENDPOINTS.register, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password}) });
  } else {
    // fallback local
    const users = Storage.getUsers();
    if(users[username]) throw new Error('TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i');
    users[username] = { username, passHash: await sha256(password), balance: 0, roles:[] };
    Storage.saveUsers(users);
    Storage.pushLog({ type:'register', username, time: now() });
    return { ok:true };
  }
}

async function loginUser(username, password){
  if(CONFIG.API_BASE){
    const res = await apiFetch(CONFIG.ENDPOINTS.login, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password}) });
    // expected: { token, user:{username,balance,roles} }
    if(res && res.token){
      setAuthToken(res.token);
      setCurrentUser(res.user);
      Storage.pushLog({ type:'login', username: res.user.username, time: now() });
      renderHeader();
      return res.user;
    }
    throw new Error('Login failed');
  } else {
    const users = Storage.getUsers();
    const rec = users[username];
    if(!rec) throw new Error('KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n');
    const h = await sha256(password);
    if(h !== rec.passHash) throw new Error('Máº­t kháº©u sai');
    setCurrentUser({ username: rec.username, roles: rec.roles || [] });
    Storage.pushLog({ type:'login', username: rec.username, time: now() });
    renderHeader();
    return rec;
  }
}

function logoutUser(){ setAuthToken(null); setCurrentUser(null); renderHeader(); }

/* session user helper using sessionStorage */
function currentUser(){ try{return JSON.parse(sessionStorage.getItem('snow_current_user')||'null')}catch(e){return null} }
function setCurrentUser(u){ if(u) sessionStorage.setItem('snow_current_user', JSON.stringify(u)); else sessionStorage.removeItem('snow_current_user'); }

/* Orders & deposits (server mode or fallback) */
async function saveOrder(order){
  if(CONFIG.API_BASE){
    // POST /orders
    return apiFetch(CONFIG.ENDPOINTS.orders, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order) });
  } else {
    const list = Storage.getOrders(); list.unshift(order); Storage.saveOrders(list); Storage.pushLog({type:'order_created', orderId:order.id, user:order.username, time:now()});
    return order;
  }
}
function getOrders(){
  if(CONFIG.API_BASE){
    // callers should use apiFetch directly; provide fallback that throws
    throw new Error('USE_API_FETCH_FOR_ORDERS_IN_SERVER_MODE');
  } else {
    return Storage.getOrders();
  }
}

async function createDepositRequest(username, amount, bank, reference){
  if(CONFIG.API_BASE){
    return apiFetch(CONFIG.ENDPOINTS.deposits, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,amount,bank,reference}) });
  } else {
    const deposits = Storage.getDeposits();
    const deposit = { id:'d_'+now(), username, amount:Number(amount)||0, bank, reference, status:'pending', createdAt: now() };
    deposits.unshift(deposit); Storage.saveDeposits(deposits);
    Storage.pushLog({type:'deposit_created', depositId:deposit.id, user:username, time:now()});
    return deposit;
  }
}

async function updateUserBalance(username, delta){
  if(CONFIG.API_BASE){
    // Implement on server (admin-only endpoint or user wallet top-up)
    return apiFetch(CONFIG.ENDPOINTS.users_admin + '/' + encodeURIComponent(username) + '/balance', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ delta }) });
  } else {
    const users = Storage.getUsers();
    if(!users[username]) throw new Error('User not found');
    users[username].balance = (users[username].balance||0) + Number(delta||0);
    Storage.saveUsers(users);
    Storage.pushLog({type:'balance_update', username, delta, time: now()});
    renderHeader();
    return users[username];
  }
}

/* forwardOrder placeholder â€” call backend if configured */
async function forwardOrderToWebhook(order){
  if(CONFIG.DISCORD_WEBHOOK) {
    const payload = {
      embeds:[{
        title:`ÄÆ¡n má»›i: ${order.package}`,
        color:3447003,
        fields:[
          {name:'NgÆ°á»i Ä‘áº·t', value:order.username || '-', inline:true},
          {name:'TÃªn/Discord', value:order.name || '-', inline:true},
          {name:'Login', value:order.login || '-', inline:true},
          {name:'GiÃ¡', value:fmt(order.price)+'Ä‘', inline:true},
          {name:'Ghi chÃº', value:order.note || '-', inline:false}
        ],
        timestamp:new Date(order.createdAt).toISOString()
      }]
    };
    const res = await fetch(CONFIG.DISCORD_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    if(!res.ok) throw new Error('Forward failed: ' + res.status);
    return res;
  }
  // If no webhook configured, just silently return
  return null;
}

/* ---------- Render / UI logic ---------- */

function renderHeader(){
  const cur = currentUser();
  const hdrUser = document.getElementById('hdr-user');
  const hdrBalance = document.getElementById('hdr-balance');
  const acctName = document.getElementById('acctName');
  const balanceEl = document.getElementById('balance');
  const hdrAdmin = document.getElementById('hdr-admin');
  if(cur){
    hdrUser.textContent = cur.username;
    // get balance from server when in server mode; fallback to local users
    if(CONFIG.API_BASE){
      // try to fetch me endpoint (best-effort)
      apiFetch(CONFIG.ENDPOINTS.me).then(res => {
        const bal = (res && res.user && res.user.balance) ? res.user.balance : 0;
        hdrBalance.textContent = fmt(bal)+'Ä‘';
        acctName.textContent = 'Xin chÃ o, ' + (res && res.user && res.user.username ? res.user.username : cur.username);
        balanceEl.textContent = fmt(bal)+'Ä‘';
        const isAdmin = (res && res.user && (res.user.roles||[]).includes('admin'));
        hdrAdmin.classList.toggle('hidden', !isAdmin);
        document.getElementById('adminPanelPlaceholder').classList.toggle('hidden', !isAdmin);
      }).catch(()=> {
        hdrBalance.textContent = 'â€”';
      });
    } else {
      const users = Storage.getUsers(); const bal = (users[cur.username] && users[cur.username].balance) || 0;
      hdrBalance.textContent = fmt(bal)+'Ä‘';
      acctName.textContent = 'Xin chÃ o, ' + cur.username;
      balanceEl.textContent = fmt(bal)+'Ä‘';
      const isAdmin = (cur.roles||[]).includes('admin');
      hdrAdmin.classList.toggle('hidden', !isAdmin);
      document.getElementById('adminPanelPlaceholder').classList.toggle('hidden', !isAdmin);
    }
  } else {
    hdrUser.textContent = 'ChÆ°a Ä‘Äƒng nháº­p';
    hdrBalance.textContent = '0Ä‘';
    acctName.textContent = 'Báº¡n chÆ°a Ä‘Äƒng nháº­p';
    balanceEl.textContent = '0Ä‘';
    hdrAdmin.classList.add('hidden');
    document.getElementById('adminPanelPlaceholder').classList.add('hidden');
  }
}

/* Build packages grid (preserve PACKAGES order unless sorting requested) */
function renderPackages({ filter=null, sortMode='default' }={}) {
  const grid = document.getElementById('packagesGrid');
  const list = PACKAGES.slice(); // preserve order
  let filtered = list;
  if(filter){
    const q = filter.trim().toLowerCase();
    filtered = list.filter(p => (p.name + ' ' + p.desc + ' ' + p.detail).toLowerCase().includes(q));
  }
  if(sortMode === 'price_asc') filtered = filtered.sort((a,b)=>a.price-b.price);
  else if(sortMode === 'price_desc') filtered = filtered.sort((a,b)=>b.price-a.price);

  grid.innerHTML = '';
  if(filtered.length === 0){
    grid.innerHTML = `<div class="kv">KhÃ´ng tÃ¬m tháº¥y gÃ³i phÃ¹ há»£p.</div>`;
    return;
  }

  for(const pkg of filtered){
    const card = document.createElement('div');
    card.className = 'card-item panel';
    card.innerHTML = `
      <div class="pkg-head">
        <div class="pkg-name">${escapeHtml(pkg.name)}</div>
        <div class="pkg-price">${fmt(pkg.price)}Ä‘</div>
      </div>
      <div class="pkg-desc">${escapeHtml(pkg.desc)}</div>
      <div class="features">
        <div class="feature"><div class="dot"></div><div>${escapeHtml(pkg.detail).replace(/\n/g,'<br>')}</div></div>
        <div class="kv">Thá»i gian: ${escapeHtml(pkg.time)}</div>
      </div>
      <div class="row-actions">
        <button class="btn buy-btn" data-id="${escapeHtml(pkg.id)}">Mua ngay</button>
        <button class="btn secondary info-btn" data-id="${escapeHtml(pkg.id)}">Chi tiáº¿t</button>
      </div>
    `;
    grid.appendChild(card);
  }

  // Attach listeners
  $$('.buy-btn').forEach(b => b.addEventListener('click', (e) => {
    const id = e.currentTarget.getAttribute('data-id');
    openOrderModal(id);
  }));
  $$('.info-btn').forEach(b => b.addEventListener('click', (e) => {
    const id = e.currentTarget.getAttribute('data-id');
    const pkg = PACKAGES.find(x => x.id === id);
    if(pkg){
      showModal(`<div class="modal"><h3>${escapeHtml(pkg.name)}</h3><p class="kv">${escapeHtml(pkg.desc)}</p><pre style="white-space:pre-wrap;margin-top:8px">${escapeHtml(pkg.detail)}</pre><div style="margin-top:12px"><button class="btn" id="closeInfo">ÄÃ³ng</button></div></div>`, {
        onOpen(){ document.getElementById('closeInfo').addEventListener('click', hideModal); }
      });
    }
  }));
}

/* Open order modal prefilled with package info (or allow selecting from #goi) */
function openOrderModal(pkgId){
  const cur = currentUser();
  if(!cur){
    // prompt login first
    showLoginModal(() => {
      // after login success, reopen order modal
      openOrderModal(pkgId);
    });
    return;
  }

  const pkg = PACKAGES.find(p => p.id === pkgId) || null;
  const defaultPackageText = pkg ? `${pkg.name} â€” ${fmt(pkg.price)}Ä‘` : '';

  const html = `
  <div class="modal">
    <h3>Äáº·t gÃ³i thuÃª</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1">
        <label class="kv">Chá»n gÃ³i</label>
        <select id="order_package_select" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
          <option value="">-- Chá»n --</option>
          ${PACKAGES.map(p=>`<option value="${escapeHtml(p.id)}" data-price="${p.price}">${escapeHtml(p.name)} â€” ${fmt(p.price)}Ä‘</option>`).join('')}
        </select>
      </div>
      <div style="width:160px">
        <label class="kv">GiÃ¡</label>
        <div id="order_price" class="kv" style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);text-align:center">${defaultPackageText || 'â€”'}</div>
      </div>
    </div>

    <div style="margin-top:10px">
      <label class="kv">Login / TÃ i khoáº£n game (báº¯t buá»™c)</label>
      <input id="order_login" placeholder="TÃªn tÃ i khoáº£n / ID" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
    </div>

    <div style="margin-top:10px">
      <label class="kv">Ghi chÃº (ná»™i dung cáº§n lÆ°u Ã½)</label>
      <textarea id="order_note" rows="3" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)"></textarea>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="order_cancel">Há»§y</button>
      <button class="btn" id="order_submit">XÃ¡c nháº­n & Thanh toÃ¡n</button>
    </div>
  </div>
  `;

  showModal(html, {
    onOpen(){
      const select = document.getElementById('order_package_select');
      const priceBox = document.getElementById('order_price');
      const loginInput = document.getElementById('order_login');
      const noteInput = document.getElementById('order_note');
      document.getElementById('order_cancel').addEventListener('click', hideModal);
      // preselect if pkgId provided
      if(pkgId){
        select.value = pkgId;
        priceBox.textContent = `${pkg.name} â€” ${fmt(pkg.price)}Ä‘`;
      }
      select.addEventListener('change', (e) => {
        const p = PACKAGES.find(x => x.id === select.value);
        priceBox.textContent = p ? `${p.name} â€” ${fmt(p.price)}Ä‘` : 'â€”';
      });
      document.getElementById('order_submit').addEventListener('click', async () => {
        const sel = select.value;
        if(!sel){ toast('Vui lÃ²ng chá»n gÃ³i', {type:'error'}); return; }
        if(!loginInput.value.trim()){ toast('Vui lÃ²ng nháº­p Login / tÃ i khoáº£n game', {type:'error'}); loginInput.focus(); return; }
        const pkg = PACKAGES.find(x => x.id === sel);
        const order = {
          id: 'o_' + now(),
          username: currentUser().username,
          package: pkg.name,
          packageId: pkg.id,
          price: pkg.price,
          login: loginInput.value.trim(),
          note: noteInput.value.trim(),
          createdAt: now(),
          status: 'pending'
        };

        try {
          await saveOrder(order);
          try{ await forwardOrderToWebhook(order); }catch(_){} // best-effort
          hideModal();
          toast('ÄÆ¡n Ä‘Ã£ Ä‘Æ°á»£c táº¡o. Vui lÃ²ng chá» xá»­ lÃ½.', { type:'info' });
          renderOrdersPreview();
        } catch (err) {
          console.error(err);
          toast('Táº¡o Ä‘Æ¡n tháº¥t báº¡i: ' + (err.message || err), {type:'error'});
        }
      });
    }
  });
}

/* simple login/register modal (uses configured API when available) */
function showLoginModal(onSuccess){
  const html = `
  <div class="modal">
    <h3>ÄÄƒng nháº­p / ÄÄƒng kÃ½</h3>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="auth_user" placeholder="TÃªn Ä‘Äƒng nháº­p" style="flex:1;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
      <input id="auth_pass" placeholder="Máº­t kháº©u" type="password" style="flex:1;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="auth_reg">ÄÄƒng kÃ½</button>
      <button class="btn" id="auth_login">ÄÄƒng nháº­p</button>
    </div>
  </div>
  `;
  showModal(html, {
    onOpen(){
      document.getElementById('auth_login').addEventListener('click', async ()=>{
        const u = document.getElementById('auth_user').value.trim();
        const p = document.getElementById('auth_pass').value;
        try{
          await loginUser(u,p);
          hideModal();
          toast('ÄÄƒng nháº­p thÃ nh cÃ´ng', { type:'info' });
          renderHeader();
          if(onSuccess) onSuccess();
        }catch(err){
          toast('Lá»—i Ä‘Äƒng nháº­p: ' + (err.message||err), {type:'error'});
        }
      });
      document.getElementById('auth_reg').addEventListener('click', async ()=>{
        const u = document.getElementById('auth_user').value.trim();
        const p = document.getElementById('auth_pass').value;
        try{
          await registerUser(u,p);
          toast('ÄÄƒng kÃ½ thÃ nh cÃ´ng. Vui lÃ²ng Ä‘Äƒng nháº­p.', {type:'info'});
        }catch(err){
          toast('Lá»—i Ä‘Äƒng kÃ½: ' + (err.message||err), {type:'error'});
        }
      });
    }
  });
}

/* Orders preview sidebar */
function renderOrdersPreview(){
  const cur = currentUser();
  const container = document.getElementById('ordersPreview');
  container.innerHTML = '';
  if(!cur){
    container.innerHTML = '<div class="kv">ÄÄƒng nháº­p Ä‘á»ƒ xem Ä‘Æ¡n cá»§a báº¡n.</div>';
    return;
  }
  if(CONFIG.API_BASE){
    // In server mode, fetch /orders?username=...
    apiFetch(CONFIG.ENDPOINTS.orders + '?username=' + encodeURIComponent(cur.username))
      .then(res => {
        if(!res || !Array.isArray(res)) { container.innerHTML = '<div class="kv">KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng.</div>'; return; }
        container.innerHTML = res.slice(0,5).map(o=>`<div class="order-small"><div>${escapeHtml(o.package)} <div class="small kv">${new Date(o.createdAt).toLocaleString()}</div></div><div class="small">${escapeHtml(o.status||'â€”')}</div></div>`).join('');
      }).catch(err => {
        container.innerHTML = '<div class="kv">KhÃ´ng thá»ƒ táº£i Ä‘Æ¡n (server error)</div>';
      });
  } else {
    const orders = getOrders().filter(o => o.username === cur.username).slice(0,5);
    if(orders.length === 0){
      container.innerHTML = '<div class="kv">Báº¡n chÆ°a cÃ³ Ä‘Æ¡n.</div>';
      return;
    }
    container.innerHTML = orders.map(o => `<div class="order-small"><div>${escapeHtml(o.package)} <div class="small kv">${new Date(o.createdAt).toLocaleString()}</div></div><div class="small">${escapeHtml(o.status||'â€”')}</div></div>`).join('');
  }
}

/* Wire search / sort / select */
const searchInput = document.getElementById('searchInput');
const sortSelect = document.getElementById('sortSelect');
const goiSelect = document.getElementById('goi');

const doRender = debounce(()=> {
  const q = searchInput.value || '';
  const sort = sortSelect.value || 'default';
  renderPackages({ filter: q, sortMode: sort });
}, 120);

searchInput.addEventListener('input', doRender);
sortSelect.addEventListener('change', doRender);

/* When user picks from the big #goi select, open order modal / autofill */
goiSelect.addEventListener('change', (e)=>{
  const v = e.target.value;
  if(!v) return;
  // value format: "Name|price" (user-provided select)
  const [name, price] = v.split('|');
  // find package by name first, fallback to a synthetic package
  const pkg = PACKAGES.find(p => p.name === name) || { id: 'custom_' + name.replace(/\s+/g,'_'), name, price: Number(price)||0 };
  // attempt to open order modal for pkg.id
  openOrderModal(pkg.id);
  // reset select to placeholder for convenience
  setTimeout(()=>{ goiSelect.value = ''; }, 200);
});

/* Attach other UI buttons */
document.getElementById('openAccount').addEventListener('click', ()=> showLoginModal());
document.getElementById('cta-order').addEventListener('click', ()=> {
  // prefer a selected package from the goi select if user already chose
  const v = goiSelect.value;
  if(v){
    const [name] = v.split('|');
    const pkg = PACKAGES.find(p => p.name === name);
    if(pkg) { openOrderModal(pkg.id); return; }
  }
  // else open general package list -> pick first package
  openOrderModal(PACKAGES[0].id);
});
document.getElementById('openDeposit').addEventListener('click', () => {
  const cur = currentUser();
  if(!cur){ showLoginModal(()=> document.getElementById('openDeposit').click()); return; }
  showModal(`
    <div class="modal">
      <h3>Táº¡o yÃªu cáº§u náº¡p</h3>
      <label class="kv">Sá»‘ tiá»n (VNÄ)</label>
      <input id="dep_amount" type="number" placeholder="Sá»‘ tiá»n" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
      <label class="kv" style="margin-top:8px">NgÃ¢n hÃ ng</label>
      <input id="dep_bank" placeholder="NgÃ¢n hÃ ng / chá»§ tÃ i khoáº£n" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
      <label class="kv" style="margin-top:8px">MÃ£ tham chiáº¿u (VD: chuyá»ƒn khoáº£n)</label>
      <input id="dep_ref" placeholder="MÃ£ ref" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn secondary" id="dep_cancel">Há»§y</button>
        <button class="btn" id="dep_create">Táº¡o yÃªu cáº§u</button>
      </div>
    </div>
  `, { onOpen(){
      document.getElementById('dep_cancel').addEventListener('click', hideModal);
      document.getElementById('dep_create').addEventListener('click', async ()=>{
        const amount = Number(document.getElementById('dep_amount').value || 0);
        const bank = document.getElementById('dep_bank').value.trim();
        const ref = document.getElementById('dep_ref').value.trim();
        if(!amount || amount <= 0){ toast('Sá»‘ tiá»n khÃ´ng há»£p lá»‡', {type:'error'}); return; }
        if(!bank || !ref){ toast('Vui lÃ²ng nháº­p thÃ´ng tin ngÃ¢n hÃ ng vÃ  mÃ£ ref', {type:'error'}); return; }
        try{
          const cur = currentUser();
          await createDepositRequest(cur.username, amount, bank, ref);
          hideModal();
          toast('YÃªu cáº§u náº¡p Ä‘Ã£ Ä‘Æ°á»£c gá»­i. Vui lÃ²ng chá» admin duyá»‡t.', {type:'info'});
          renderHeader();
        }catch(err){
          toast('Táº¡o yÃªu cáº§u tháº¥t báº¡i: ' + (err.message||err), {type:'error'});
        }
      });
    }});
});

/* orders listing page (simple) */
document.getElementById('viewOrders').addEventListener('click', () => {
  const cur = currentUser();
  if(!cur){ showLoginModal(()=> document.getElementById('viewOrders').click()); return; }
  if(CONFIG.API_BASE){
    // open modal and fetch from server
    apiFetch(CONFIG.ENDPOINTS.orders + '?username=' + encodeURIComponent(cur.username)).then(res => {
      const rows = (res && Array.isArray(res)) ? res : [];
      showModal(`<div class="modal"><h3>ÄÆ¡n hÃ ng</h3><div style="max-height:400px;overflow:auto">${rows.map(r=>`<div style="padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)"><strong>${escapeHtml(r.package)}</strong><div class="small kv">${new Date(r.createdAt).toLocaleString()}</div><div class="small">Tráº¡ng thÃ¡i: ${escapeHtml(r.status||'â€”')}</div></div>`).join('') || '<div class="kv">KhÃ´ng cÃ³ Ä‘Æ¡n</div>'}</div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" id="orders_close">ÄÃ³ng</button></div></div>`, { onOpen(){ document.getElementById('orders_close').addEventListener('click', hideModal); }});
    }).catch(err => {
      toast('KhÃ´ng thá»ƒ táº£i Ä‘Æ¡n tá»« server', {type:'error'});
    });
  } else {
    const rows = getOrders().filter(o => o.username === cur.username);
    showModal(`<div class="modal"><h3>ÄÆ¡n hÃ ng</h3><div style="max-height:400px;overflow:auto">${rows.map(r=>`<div style="padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)"><strong>${escapeHtml(r.package)}</strong><div class="small kv">${new Date(r.createdAt).toLocaleString()}</div><div class="small">Tráº¡ng thÃ¡i: ${escapeHtml(r.status||'â€”')}</div></div>`).join('') || '<div class="kv">KhÃ´ng cÃ³ Ä‘Æ¡n</div>'}</div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" id="orders_close">ÄÃ³ng</button></div></div>`, { onOpen(){ document.getElementById('orders_close').addEventListener('click', hideModal); }});
  }
});

/* Quick init: create demo users in fallback mode only (server mode should seed admin elsewhere) */
(async function initFallbackUsers(){
  if(CONFIG.API_BASE) return;
  const users = Storage.getUsers();
  if(!users['demo']){
    users['demo'] = { username:'demo', passHash: await sha256('demo'), balance: 50000, roles:[] };
  }
  // It's recommended NOT to auto-create 'admin' in production fallback; leave to developer.
  Storage.saveUsers(users);
})();

/* Initial render */
renderHeader();
renderPackages();
renderOrdersPreview();

/* Expose some functions for debugging in console (optional) */
window.SNOW = {
  CONFIG, PACKAGES, renderPackages, renderOrdersPreview, currentUser, setCurrentUser, apiFetch
};
</script>
</body>
</html>
