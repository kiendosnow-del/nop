<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SNOW SHOP â€” ThuÃª cÃ y Blox Fruits (Pro)</title>

<!-- Font -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#04101b; --panel:#071326; --card:#0d1a2a; --muted:#9aa3af; --text:#e6eef6;
  --accent:#06b6d4; --accent-2:#60a5fa; --success:#10b981; --danger:#ef4444;
  --glass: rgba(255,255,255,0.02); --radius:12px; --shadow: 0 12px 34px rgba(2,6,23,0.6);
  --max-w:1200px; --gap:14px; --tran:200ms;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:linear-gradient(180deg,#03101a,#041426);color:var(--text);
  -webkit-font-smoothing:antialiased;
}

/* Layout */
.container{max-width:var(--max-w);margin:18px auto;padding:12px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:54px;height:54px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#2563eb);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021022}
.title{font-weight:700}
.header-meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:14px}

/* Nav */
.nav{display:flex;gap:8px;justify-content:center;margin-bottom:14px}
.nav button{background:transparent;border:0;color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:all var(--tran)}
.nav button[aria-current="true"], .nav button:hover{color:var(--text);background:var(--glass)}

/* Main grid */
.main{display:grid;grid-template-columns:1fr 360px;gap:18px}
@media (max-width:980px){ .main{grid-template-columns:1fr} }

.panel{background:linear-gradient(180deg,var(--panel),#061426);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}

/* Hero + controls */
.hero{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,rgba(6,182,212,0.05),rgba(58,123,213,0.03))}
.hero h1{margin:0;font-size:20px}
.controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.controls input, .controls select{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:10px;border-radius:10px;width:100%}
.controls .col{flex:1;min-width:160px}

/* Packages grid */
.grid{margin-top:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap)}
@media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
@media (max-width:640px){ .grid{grid-template-columns:1fr} }

.card-item{padding:14px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.014),transparent);border:1px solid rgba(255,255,255,0.03);transition:transform var(--tran),box-shadow var(--tran)}
.card-item:hover{transform:translateY(-6px);box-shadow:0 18px 36px rgba(0,0,0,0.6)}
.pkg-head{display:flex;justify-content:space-between;align-items:center}
.pkg-name{font-weight:800}
.pkg-price{font-weight:800;color:var(--accent)}
.pkg-desc{color:var(--muted);margin-top:8px;font-size:13px}
.features{margin-top:10px;color:var(--muted);font-size:13px}
.feature{display:flex;gap:8px;align-items:flex-start;margin-bottom:6px}
.feature .dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent-2));margin-top:6px}

/* actions */
.row-actions{display:flex;gap:8px;margin-top:12px}
.btn{border:0;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;color:#021022;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:transform var(--tran)}
.btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04)}
.btn:active{transform:translateY(1px)}

/* Sidebar pieces */
.sidebar{display:flex;flex-direction:column;gap:12px}
.wallet .balance{font-weight:800;color:var(--accent);font-size:18px;margin-top:8px}
.orders-preview .order-small{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--glass);margin-bottom:8px}

/* admin */
.admin-badge{background:linear-gradient(90deg,#facc15,#eab308);color:#021022;padding:6px 8px;border-radius:999px;font-weight:700}

/* modal/toast */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:100%;max-width:760px;background:linear-gradient(180deg,#071022,#05101a);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:70}
.kv{color:var(--muted);font-size:13px}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden>SS</div>
      <div>
        <div class="title">SNOW SHOP</div>
        <div class="kv">ThuÃª cÃ y Blox Fruits â€” Cao cáº¥p â€¢ Uy tÃ­n â€¢ Báº£o máº­t</div>
      </div>
    </div>

    <div class="header-meta" aria-hidden>
      <div>ğŸ‘¤ <strong id="hdr-user">ChÆ°a Ä‘Äƒng nháº­p</strong> <span id="hdr-admin" class="admin-badge hidden">ADMIN</span></div>
      <div>ğŸ’° <strong id="hdr-balance">0Ä‘</strong></div>
    </div>
  </header>

  <nav class="nav" role="navigation">
    <button data-tab="packages" aria-current="true">GÃ³i dá»‹ch vá»¥</button>
    <button data-tab="account">TÃ i khoáº£n</button>
    <button data-tab="orders">Lá»‹ch sá»­</button>
    <button id="nav-deposit">Náº¡p bank</button>
    <button id="contactBtn">LiÃªn há»‡</button>
  </nav>

  <main class="main">
    <!-- left -->
    <section class="panel" id="leftPanel">
      <div class="hero">
        <div>
          <h1>ThuÃª cÃ y chuyÃªn nghiá»‡p â€” An toÃ n & Nhanh</h1>
          <p class="kv">Chá»n gÃ³i theo nhu cáº§u. Thanh toÃ¡n báº±ng vÃ­ (sá»‘ dÆ°) hoáº·c náº¡p bank. Admin cÃ³ quyá»n gift & duyá»‡t náº¡p.</p>
          <div style="margin-top:10px">
            <button class="btn" id="cta-order">Mua ngay</button>
            <button class="btn secondary" id="cta-learn">CÃ¡ch hoáº¡t Ä‘á»™ng</button>
          </div>
        </div>
        <div style="text-align:right">
          <div class="kv">Há»— trá»£ 24/7</div>
          <div style="margin-top:10px" class="kv">Cam káº¿t hoÃ n tiá»n náº¿u vi pháº¡m</div>
        </div>
      </div>

      <div class="controls" style="margin-top:12px">
        <input id="searchInput" placeholder="TÃ¬m kiáº¿m gÃ³i (vÃ­ dá»¥: Tushita, Level,...)" />
        <select id="sortSelect" aria-label="Sáº¯p xáº¿p">
          <option value="default">Máº·c Ä‘á»‹nh</option>
          <option value="price_asc">GiÃ¡ tÄƒng dáº§n</option>
          <option value="price_desc">GiÃ¡ giáº£m dáº§n</option>
        </select>
      </div>

      <div id="packagesGrid" class="grid" aria-live="polite"></div>
    </section>

    <!-- right -->
    <aside class="sidebar">
      <div class="panel wallet">
        <div class="kv">TÃ i khoáº£n</div>
        <div id="acctName" class="kv" style="margin-top:6px">Báº¡n chÆ°a Ä‘Äƒng nháº­p</div>
        <div id="balance" class="balance">0Ä‘</div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="openAccount">ÄÄƒng nháº­p / ÄÄƒng kÃ½</button>
          <button class="btn secondary" id="quickBuy">Äáº·t nhanh</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn secondary" id="openDeposit">Náº¡p bank</button>
        </div>
      </div>

      <div class="panel orders-preview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>ÄÆ¡n gáº§n Ä‘Ã¢y</strong>
          <button class="small" id="viewOrders">Xem táº¥t cáº£</button>
        </div>
        <div id="ordersPreview" style="margin-top:12px"></div>
      </div>

      <div id="adminPanelPlaceholder" class="panel hidden">
        <strong>Admin</strong>
        <div style="margin-top:8px">
          <button class="btn" id="openAdminPanel">Báº£ng quáº£n trá»‹</button>
        </div>
      </div>

      <div class="panel">
        <strong>Há»— trá»£</strong>
        <div class="kv" style="margin-top:8px">Discord / Telegram / Zalo â€” cáº­p nháº­t</div>
        <div style="margin-top:12px"><button class="btn secondary" id="contactSupport">Má»Ÿ kÃªnh há»— trá»£</button></div>
      </div>
    </aside>
  </main>
</div>

<!-- modal + toast root -->
<div id="modalRoot" class="hidden" aria-hidden="true"></div>
<div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* ====================================================================================
   SNOW SHOP (single-file demo)
   - Fixed bugs, optimized rendering
   - Packages list matches provided <select> content exactly and grouped/sorted
   - Admin account: username=admin password=admin
   - Admin panel: gift money to user; review & approve/decline bank deposits
   - Deposit flow (user creates deposit request with bank ref; admin approves -> credit)
   - Orders: store in localStorage, attempt to forward via DISCORD_WEBHOOK (left empty)
   - Notes: demo stores everything client-side. For production, implement server-side APIs.
   ==================================================================================== */

/* CONFIG */
const DISCORD_WEBHOOK = ""; // backend forwarding endpoint (do NOT put Discord raw webhook here)

/* PACKAGE definition in requested order/grouping */
const PACKAGES = [
  // Group: LEVEL
  { id:'level_700', name:'Level 700', price:20000, group:'LEVEL', desc:'Farm nhanh lÃªn level 700', detail:'âœ” Farm quest nhanh\nâœ” KhÃ´ng Ä‘á»•i trÃ¡i\nâœ” 3â€“5 giá»', time:'3â€“5 giá»' },
  { id:'700_1500', name:'700 â†’ 1500', price:20000, group:'LEVEL', desc:'Farm tá»« Sea 2', detail:'âœ” Farm boss + quest\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },
  { id:'1500_2800', name:'1500 â†’ 2800', price:20000, group:'LEVEL', desc:'Farm Sea 3', detail:'âœ” Farm full Sea 3\nâœ” An toÃ n 100%\nâœ” 2â€“3 ngÃ y', time:'2â€“3 ngÃ y' },
  { id:'0_max', name:'0 â†’ MAX', price:50000, group:'LEVEL', desc:'CÃ y tá»« Ä‘áº§u tá»›i max', detail:'âœ” Full Sea 1â€“2â€“3\nâœ” KhÃ´ng máº¥t acc\nâœ” 4â€“6 ngÃ y', time:'4â€“6 ngÃ y' },

  // Group: ITEM
  { id:'mo_neo', name:'Má» Neo', price:20000, group:'ITEM', desc:'LÃ m Má» Neo', detail:'âœ” Full quest\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1 ngÃ y', time:'1 ngÃ y' },
  { id:'tushita', name:'Tushita', price:15000, group:'ITEM', desc:'Kiáº¿m Tushita', detail:'âœ” Full quest\nâœ” An toÃ n\nâœ” Trong ngÃ y', time:'Trong ngÃ y' },
  { id:'yama', name:'Yama', price:30000, group:'ITEM', desc:'Kiáº¿m Yama', detail:'âœ” Full Yama\nâœ” KhÃ´ng máº¥t Ä‘á»“\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },
  { id:'tam_kiem', name:'Tam Kiáº¿m Full', price:35000, group:'ITEM', desc:'True Triple Katana', detail:'âœ” Full 3 kiáº¿m\nâœ” KhÃ´ng rollback\nâœ” 2â€“3 ngÃ y', time:'2â€“3 ngÃ y' },
  { id:'cdk', name:'CDK', price:30000, group:'ITEM', desc:'Cursed Dual Katana', detail:'âœ” Full CDK\nâœ” KhÃ´ng máº¥t item\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },

  // Group: V4
  { id:'full_v4', name:'Full Gear V4', price:30000, group:'V4', desc:'Full Gear V4', detail:'âœ” Full Gear\nâœ” Thá»©c tá»‰nh V4\nâœ” 1â€“2 ngÃ y', time:'1â€“2 ngÃ y' },
  { id:'one_v4', name:'1 Gear V4', price:5000, group:'V4', desc:'Up 1 Gear', detail:'âœ” 1 Gear báº¥t ká»³\nâœ” Nhanh gá»n\nâœ” Trong ngÃ y', time:'Trong ngÃ y' },

  // Group: MELEE
  { id:'godhuman', name:'Godhuman', price:20000, group:'MELEE', desc:'Melee Godhuman', detail:'âœ” Full Godhuman\nâœ” Farm nguyÃªn liá»‡u\nâœ” 1 ngÃ y', time:'1 ngÃ y' },
  { id:'melee_v2', name:'Melee V2', price:15000, group:'MELEE', desc:'Up Melee V2', detail:'âœ” Melee V2\nâœ” Nhanh\nâœ” Trong ngÃ y', time:'Trong ngÃ y' }
];

/* Storage wrapper (users, orders, deposits, logs) */
const Storage = {
  usersKey: 'snow_users_v5',
  ordersKey: 'snow_orders_v5',
  depositsKey: 'snow_deposits_v5',
  logsKey: 'snow_logs_v5',
  getUsers(){ try{return JSON.parse(localStorage.getItem(this.usersKey)||'{}')}catch(e){return{}} },
  saveUsers(v){ localStorage.setItem(this.usersKey, JSON.stringify(v)) },
  getOrders(){ try{return JSON.parse(localStorage.getItem(this.ordersKey)||'[]')}catch(e){return[]} },
  saveOrders(v){ localStorage.setItem(this.ordersKey, JSON.stringify(v)) },
  getDeposits(){ try{return JSON.parse(localStorage.getItem(this.depositsKey)||'[]')}catch(e){return[]} },
  saveDeposits(v){ localStorage.setItem(this.depositsKey, JSON.stringify(v)) },
  pushLog(entry){ const l = JSON.parse(localStorage.getItem(this.logsKey)||'[]'); l.unshift(entry); localStorage.setItem(this.logsKey, JSON.stringify(l)); }
};

/* Utilities */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => (Number(n)||0).toLocaleString('vi-VN');
const now = () => Date.now();
async function sha256(msg){ const enc = new TextEncoder(); const buf = await crypto.subtle.digest('SHA-256', enc.encode(msg)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn, wait=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); } }

/* Current user (session) helpers */
function currentUser(){ try{return JSON.parse(sessionStorage.getItem('snow_current_user')||'null')}catch(e){return null} }
function setCurrentUser(u){ if(u) sessionStorage.setItem('snow_current_user', JSON.stringify(u)); else sessionStorage.removeItem('snow_current_user'); }

/* Toast */
const toastWrap = document.getElementById('toastWrap');
function toast(msg, {type='info', timeout=3000}={}) {
  const el = document.createElement('div');
  el.className = 'panel';
  el.style.padding='10px';
  el.style.minWidth='200px';
  el.style.borderRadius='8px';
  el.style.background = type==='error' ? 'linear-gradient(180deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02))' : 'linear-gradient(180deg, rgba(6,182,212,0.04), transparent)';
  el.textContent = msg;
  toastWrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateX(12px)'; setTimeout(()=>el.remove(),300); }, timeout);
}

/* Modal */
const modalRoot = document.getElementById('modalRoot');
function showModal(contentHTML, {onOpen=null}={}) {
  modalRoot.innerHTML = `<div class="modal-backdrop" id="modalBackdrop">${contentHTML}</div>`;
  modalRoot.classList.remove('hidden');
  requestAnimationFrame(()=> {
    const focusable = modalRoot.querySelector('button, input, textarea, [tabindex]:not([tabindex="-1"])');
    if(focusable) focusable.focus();
    if(onOpen) onOpen();
  });
  function onKey(e){ if(e.key==='Escape') hideModal(); }
  document.addEventListener('keydown', onKey);
  modalRoot._onKey = onKey;
}
function hideModal(){ modalRoot.innerHTML=''; modalRoot.classList.add('hidden'); if(modalRoot._onKey) document.removeEventListener('keydown', modalRoot._onKey); }

/* Initialize demo users (admin + demo) if missing */
(async function initDemoUsers(){
  const users = Storage.getUsers();
  if(!users['admin']){
    users['admin'] = { username:'admin', passHash: await sha256('admin'), balance: 0, roles:['admin'] };
  }
  if(!users['demo']){
    users['demo'] = { username:'demo', passHash: await sha256('demo'), balance: 50000, roles:[] };
  }
  Storage.saveUsers(users);
})();

/* Auth functions */
async function registerUser(username, password){
  if(!username || !password) throw new Error('Nháº­p tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u');
  const users = Storage.getUsers();
  if(users[username]) throw new Error('TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i');
  users[username] = { username, passHash: await sha256(password), balance: 0, roles:[] };
  Storage.saveUsers(users);
  Storage.pushLog({ type:'register', username, time: now() });
}
async function loginUser(username, password){
  const users = Storage.getUsers();
  const rec = users[username];
  if(!rec) throw new Error('KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n');
  const h = await sha256(password);
  if(h !== rec.passHash) throw new Error('Máº­t kháº©u sai');
  setCurrentUser({ username: rec.username, roles: rec.roles || [] });
  Storage.pushLog({ type:'login', username, time: now() });
  renderHeader();
}
function logoutUser(){ setCurrentUser(null); renderHeader(); }

/* Orders & deposits */
function saveOrder(order){
  const list = Storage.getOrders(); list.unshift(order); Storage.saveOrders(list); Storage.pushLog({type:'order_created', orderId:order.id, user:order.username, time:now()});
}
function getOrders(){ return Storage.getOrders(); }

function createDepositRequest(username, amount, bank, reference){
  const deposits = Storage.getDeposits();
  const deposit = { id:'d_'+now(), username, amount:Number(amount)||0, bank, reference, status:'pending', createdAt: now() };
  deposits.unshift(deposit); Storage.saveDeposits(deposits);
  Storage.pushLog({type:'deposit_created', depositId:deposit.id, user:username, time:now()});
  return deposit;
}
function updateUserBalance(username, delta){
  const users = Storage.getUsers();
  if(!users[username]) throw new Error('User not found');
  users[username].balance = (users[username].balance||0) + Number(delta||0);
  Storage.saveUsers(users);
  Storage.pushLog({type:'balance_update', username, delta, time: now()});
}

/* forwardOrder placeholder â€” call backend if configured */
async function forwardOrderToWebhook(order){
  if(!DISCORD_WEBHOOK) throw new Error('No webhook configured');
  const payload = {
    embeds:[{
      title:`ÄÆ¡n má»›i: ${order.package}`,
      color:3447003,
      fields:[
        {name:'NgÆ°á»i Ä‘áº·t', value:order.username, inline:true},
        {name:'TÃªn/Discord', value:order.name || '-', inline:true},
        {name:'Login', value:order.login || '-', inline:true},
        {name:'GiÃ¡', value:fmt(order.price)+'Ä‘', inline:true},
        {name:'Ghi chÃº', value:order.note || '-', inline:false}
      ],
      timestamp:new Date(order.createdAt).toISOString()
    }]
  };
  const res = await fetch(DISCORD_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  if(!res.ok) throw new Error('Forward failed: ' + res.status);
  return res;
}

/* Rendering functions */
function renderHeader(){
  const cur = currentUser();
  const hdrUser = document.getElementById('hdr-user');
  const hdrBalance = document.getElementById('hdr-balance');
  const acctName = document.getElementById('acctName');
  const balanceEl = document.getElementById('balance');
  const hdrAdmin = document.getElementById('hdr-admin');
  if(cur){
    hdrUser.textContent = cur.username;
    const users = Storage.getUsers(); const bal = (users[cur.username] && users[cur.username].balance) || 0;
    hdrBalance.textContent = fmt(bal)+'Ä‘';
    acctName.textContent = 'Xin chÃ o, ' + cur.username;
    balanceEl.textContent = fmt(bal)+'Ä‘';
    const isAdmin = (cur.roles||[]).includes('admin');
    hdrAdmin.classList.toggle('hidden', !isAdmin);
    document.getElementById('adminPanelPlaceholder').classList.toggle('hidden', !isAdmin);
  } else {
    hdrUser.textContent = 'ChÆ°a Ä‘Äƒng nháº­p';
    hdrBalance.textContent = '0Ä‘';
    acctName.textContent = 'Báº¡n chÆ°a Ä‘Äƒng nháº­p';
    balanceEl.textContent = '0Ä‘';
    hdrAdmin.classList.add('hidden');
    document.getElementById('adminPanelPlaceholder').classList.add('hidden');
  }
}

/* Build packages grid (grouping preserved in provided order) */
function renderPackages(filter=null, sortMode='default'){
  const grid = document.getElementById('packagesGrid');
  const list = PACKAGES.slice(); // preserve order
  let filtered = list;
  if(filter){
    const q = filter.trim().toLowerCase();
    filtered = list.filter(p => (p.name + ' ' + p.desc + ' ' + p.detail).toLowerCase().includes(q));
  }
  if(sortMode === 'price_asc') filtered.sort((a,b)=>a.price-b.price);
  else if(sortMode==='price_desc') filtered.sort((a,b)=>b.price-a.price);
  // Render
  const frag = document.createDocumentFragment();
  filtered.forEach(p => {
    const div = document.createElement('div');
    div.className = 'card-item';
    div.innerHTML = `
      <div class="pkg-head">
        <div>
          <div class="pkg-name">${escapeHtml(p.name)}</div>
          <div class="pkg-desc">${escapeHtml(p.desc)}</div>
        </div>
        <div style="text-align:right">
          <div class="pkg-price">${fmt(p.price)}Ä‘</div>
          <div class="kv" style="font-size:12px">${escapeHtml(p.time)}</div>
        </div>
      </div>
      <div class="features"><div class="kv" style="white-space:pre-line">${escapeHtml(p.detail)}</div></div>
      <div class="row-actions">
        <button class="btn" data-buy="${p.id}">Äáº¶T NGAY</button>
        <button class="btn secondary" data-info="${p.id}">CHI TIáº¾T</button>
      </div>
    `;
    frag.appendChild(div);
  });
  grid.innerHTML = '';
  grid.appendChild(frag);
}

/* Render orders preview */
function renderOrdersPreview(){
  const container = document.getElementById('ordersPreview');
  const orders = Storage.getOrders();
  if(!orders || orders.length===0){ container.innerHTML = '<div class="kv">ChÆ°a cÃ³ Ä‘Æ¡n gáº§n Ä‘Ã¢y</div>'; return; }
  container.innerHTML = orders.slice(0,6).map(o=>`
    <div class="order-small">
      <div style="max-width:65%"><strong>${escapeHtml(o.package)}</strong><div class="kv" style="font-size:12px">${escapeHtml(o.name)} â€¢ ${escapeHtml(o.login)}</div></div>
      <div style="text-align:right"><div class="kv">${fmt(o.price)}Ä‘</div><div class="kv" style="color:${o.sent? 'var(--success)':'var(--accent)'}">${o.sent? 'ÄÃ£ gá»­i':'ChÆ°a gá»­i'}</div></div>
    </div>
  `).join('');
}

/* Render deposits for admin modal */
function renderDepositsForAdmin(){
  return Storage.getDeposits().slice(0,100).map(d => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;background:var(--glass)">
      <div>
        <div><strong>${escapeHtml(d.username)}</strong> â€¢ <span class="kv">${escapeHtml(d.bank)} â€¢ Ref: ${escapeHtml(d.reference)}</span></div>
        <div class="kv">Sá»‘ tiá»n: ${fmt(d.amount)}Ä‘ â€” Tráº¡ng thÃ¡i: ${escapeHtml(d.status)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        ${d.status === 'pending' ? `<button class="btn admin-approve" data-deposit="${d.id}">Duyá»‡t</button>
        <button class="btn secondary admin-decline" data-deposit="${d.id}">Tá»« chá»‘i</button>` : `<div class="kv">${escapeHtml(d.status)}</div>`}
      </div>
    </div>
  `).join('');
}

/* Event wiring (delegation) */
document.addEventListener('click', async (e) => {
  // package buy
  const buyBtn = e.target.closest('[data-buy]');
  if(buyBtn){
    const id = buyBtn.getAttribute('data-buy'); const pkg = PACKAGES.find(p=>p.id===id);
    openOrderModal(pkg);
    return;
  }
  // package info
  const infoBtn = e.target.closest('[data-info]');
  if(infoBtn){
    const id = infoBtn.getAttribute('data-info'); const pkg = PACKAGES.find(p=>p.id===id);
    showInfoModal(pkg);
    return;
  }
  // admin approve/decline
  if(e.target.matches('.admin-approve')){
    const depId = e.target.getAttribute('data-deposit');
    adminApproveDeposit(depId);
    return;
  }
  if(e.target.matches('.admin-decline')){
    const depId = e.target.getAttribute('data-deposit');
    adminDeclineDeposit(depId);
    return;
  }
});

/* Search + sort */
const onSearch = debounce(()=> {
  const q = document.getElementById('searchInput').value;
  const sort = document.getElementById('sortSelect').value;
  renderPackages(q, sort);
}, 160);

/* Hook controls */
document.getElementById('searchInput').addEventListener('input', onSearch);
document.getElementById('sortSelect').addEventListener('change', onSearch);
document.getElementById('cta-learn').addEventListener('click', ()=> alert('1) Chá»n gÃ³i â†’ 2) Äáº·t Ä‘Æ¡n â†’ 3) Ká»¹ thuáº­t thi hÃ nh â†’ 4) HoÃ n thÃ nh vÃ  Ä‘Ã¡nh giÃ¡'));
document.getElementById('openAccount').addEventListener('click', openAuthModal);
document.getElementById('quickBuy').addEventListener('click', ()=> openOrderModal(PACKAGES[0]));
document.getElementById('viewOrders').addEventListener('click', openOrdersModal);
document.getElementById('openDeposit').addEventListener('click', openDepositModal);
document.getElementById('nav-deposit').addEventListener('click', openDepositModal);
document.getElementById('contactSupport').addEventListener('click', ()=> alert('Má»Ÿ kÃªnh há»— trá»£...'));
document.getElementById('contactBtn').addEventListener('click', ()=> alert('LiÃªn há»‡: Discord / Telegram / Zalo'));

/* Nav simple: only account/orders open modal */
$$('.nav button').forEach(b => b.addEventListener('click', ()=> {
  $$('.nav button').forEach(x=>x.setAttribute('aria-current','false'));
  b.setAttribute('aria-current','true');
  const tab = b.getAttribute('data-tab');
  if(tab === 'account') openAuthModal();
  if(tab === 'orders') openOrdersModal();
}));

/* --- Modals --- */
function showInfoModal(pkg){
  showModal(`<div class="modal">
    <h3>${escapeHtml(pkg.name)} â€” ${fmt(pkg.price)}Ä‘</h3>
    <p class="kv" style="white-space:pre-line">${escapeHtml(pkg.detail)}</p>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="infoBuy">Äáº·t gÃ³i</button>
      <button class="btn secondary" id="infoClose">ÄÃ³ng</button>
    </div>
  </div>`, {
    onOpen: ()=>{
      document.getElementById('infoClose').addEventListener('click', hideModal);
      document.getElementById('infoBuy').addEventListener('click', ()=>{ hideModal(); openOrderModal(pkg); });
    }
  });
}
function openOrderModal(pkg){
  showModal(`<div class="modal">
    <h3>Äáº·t gÃ³i â€” ${escapeHtml(pkg.name)} <span style="float:right;color:var(--accent)">${fmt(pkg.price)}Ä‘</span></h3>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
      <input id="o_name" placeholder="TÃªn Roblox / Discord" style="padding:10px;border-radius:8px"/>
      <input id="o_login" placeholder="Login Roblox" style="padding:10px;border-radius:8px"/>
      <textarea id="o_note" placeholder="Ghi chÃº (pass, yÃªu cáº§u...)" style="padding:10px;border-radius:8px"></textarea>
      <div style="display:flex;gap:8px">
        <label class="kv"><input type="radio" name="pay" value="wallet" checked> Thanh toÃ¡n vÃ­</label>
        <label class="kv"><input type="radio" name="pay" value="bank"> Náº¡p bank (táº¡o yÃªu cáº§u)</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="o_confirm">XÃC NHáº¬N</button>
      <button class="btn secondary" id="o_cancel">Há»¦Y</button>
    </div>
  </div>`, {
    onOpen: ()=>{
      const cur = currentUser();
      if(cur) document.getElementById('o_name').value = cur.username;
      document.getElementById('o_cancel').addEventListener('click', hideModal);
      document.getElementById('o_confirm').addEventListener('click', async ()=>{
        const curUser = currentUser();
        if(!curUser){ if(confirm('Báº¡n chÆ°a Ä‘Äƒng nháº­p. ÄÄƒng nháº­p bÃ¢y giá»?')){ hideModal(); openAuthModal(); } return; }
        const name = document.getElementById('o_name').value.trim();
        const login = document.getElementById('o_login').value.trim();
        const note = document.getElementById('o_note').value.trim();
        const payMode = Array.from(document.getElementsByName('pay')).find(r=>r.checked).value;
        if(!name || !login){ toast('Nháº­p tÃªn vÃ  login', {type:'error'}); return; }
        if(payMode === 'wallet'){
          // attempt to deduct
          const users = Storage.getUsers();
          const bal = (users[curUser.username] && users[curUser.username].balance) || 0;
          if(bal < pkg.price){ if(!confirm('Sá»‘ dÆ° khÃ´ng Ä‘á»§. Báº¡n muá»‘n táº¡o Ä‘Æ¡n vÃ  náº¡p bank?')) return; }
          else {
            users[curUser.username].balance = bal - pkg.price;
            Storage.saveUsers(users);
            Storage.pushLog({type:'order_paid_wallet', user:curUser.username, amount:pkg.price, time:now()});
          }
        }
        const order = { id:'o_'+now(), username:curUser.username, name, login, package:pkg.name, price:pkg.price, note, createdAt: now(), sent:false, payMode };
        saveOrder(order);
        renderOrdersPreview(); renderHeader();
        hideModal();
        toast('ÄÆ¡n Ä‘Ã£ Ä‘Æ°á»£c lÆ°u. Há»‡ thá»‘ng sáº½ xá»­ lÃ½.');
        // try forward
        try{
          await forwardOrderToWebhook(order);
          const list = Storage.getOrders(); const idx = list.findIndex(x=>x.id===order.id); if(idx>=0){ list[idx].sent=true; Storage.saveOrders(list); renderOrdersPreview(); }
          toast('ÄÃ£ gá»­i Ä‘Æ¡n tá»›i há»‡ thá»‘ng quáº£n lÃ½');
        }catch(err){
          toast('KhÃ´ng thá»ƒ gá»­i tá»± Ä‘á»™ng â€” hÃ£y dÃ¹ng backend Ä‘á»ƒ forward', {type:'error', timeout:5000});
        }
      });
    }
  });
}

/* Auth modal */
function openAuthModal(){
  showModal(`<div class="modal">
    <h3>TÃ i khoáº£n</h3>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input id="m_user" placeholder="TÃªn Ä‘Äƒng nháº­p" style="flex:1;padding:10px;border-radius:8px"/>
      <input id="m_pass" type="password" placeholder="Máº­t kháº©u" style="flex:1;padding:10px;border-radius:8px"/>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="m_login">ÄÄƒng nháº­p</button>
      <button class="btn secondary" id="m_register">ÄÄƒng kÃ½</button>
      <button class="btn secondary" id="m_close">ÄÃ³ng</button>
    </div>
    <p class="kv" style="margin-top:10px">Demo lÆ°u dá»¯ liá»‡u cá»¥c bá»™. KhÃ´ng dÃ¹ng tÃ i khoáº£n quan trá»ng.</p>
  </div>`, {
    onOpen: ()=>{
      document.getElementById('m_close').addEventListener('click', hideModal);
      document.getElementById('m_register').addEventListener('click', async ()=>{
        const u=document.getElementById('m_user').value.trim(), p=document.getElementById('m_pass').value;
        try{ await registerUser(u,p); toast('ÄÄƒng kÃ½ thÃ nh cÃ´ng'); document.getElementById('m_pass').value=''; } catch(err){ toast(err.message||'Lá»—i',{type:'error'}); }
      });
      document.getElementById('m_login').addEventListener('click', async ()=>{
        const u=document.getElementById('m_user').value.trim(), p=document.getElementById('m_pass').value;
        try{ await loginUser(u,p); hideModal(); toast('ÄÄƒng nháº­p thÃ nh cÃ´ng'); renderHeader(); } catch(err){ toast(err.message||'Lá»—i',{type:'error'}); }
      });
    }
  });
}

/* Deposit modal (user creates bank deposit request) */
function openDepositModal(){
  const cur = currentUser();
  if(!cur){ if(confirm('Báº¡n chÆ°a Ä‘Äƒng nháº­p. ÄÄƒng nháº­p bÃ¢y giá»?')) openAuthModal(); return; }
  showModal(`<div class="modal">
    <h3>Náº¡p bank (Táº¡o yÃªu cáº§u)</h3>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
      <input id="dep_amount" type="number" placeholder="Sá»‘ tiá»n (VNÄ)" style="padding:10px;border-radius:8px"/>
      <input id="dep_bank" placeholder="NgÃ¢n hÃ ng (VD: Vietcombank)" style="padding:10px;border-radius:8px"/>
      <input id="dep_ref" placeholder="MÃ£ giao dá»‹ch / ghi chÃº (Ref)" style="padding:10px;border-radius:8px"/>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="dep_submit">Táº O YÃŠU Cáº¦U</button>
      <button class="btn secondary" id="dep_cancel">Há»¦Y</button>
    </div>
    <p class="kv" style="margin-top:10px">Sau khi táº¡o, admin sáº½ duyá»‡t vÃ  cá»™ng tiá»n vÃ o vÃ­ báº¡n.</p>
  </div>`, {
    onOpen: ()=>{
      document.getElementById('dep_cancel').addEventListener('click', hideModal);
      document.getElementById('dep_submit').addEventListener('click', ()=>{
        const amt = Number(document.getElementById('dep_amount').value||0);
        const bank = document.getElementById('dep_bank').value.trim();
        const ref = document.getElementById('dep_ref').value.trim();
        if(!amt || !bank || !ref){ toast('Nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin', {type:'error'}); return; }
        createDepositRequest(currentUser().username, amt, bank, ref);
        hideModal(); toast('YÃªu cáº§u náº¡p Ä‘Ã£ táº¡o â€” chá» admin duyá»‡t');
      });
    }
  });
}

/* Orders modal (full list) */
function openOrdersModal(){
  const list = Storage.getOrders();
  showModal(`<div class="modal">
    <h3>Lá»‹ch sá»­ Ä‘Æ¡n hÃ ng</h3>
    <div style="max-height:420px;overflow:auto;margin-top:12px">
      ${list.length===0 ? '<p class="kv">ChÆ°a cÃ³ Ä‘Æ¡n nÃ o.</p>' : list.map(o=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;background:var(--glass)">
          <div style="max-width:70%"><strong>${escapeHtml(o.package)}</strong><div class="kv">${escapeHtml(o.name)} â€¢ ${escapeHtml(o.login)}</div><div class="kv" style="margin-top:6px">Ghi chÃº: ${escapeHtml(o.note||'â€”')}</div></div>
          <div style="text-align:right"><div style="font-weight:800">${fmt(o.price)}Ä‘</div><div class="kv" style="color:${o.sent? 'var(--success)':'var(--accent)'}">${o.sent? 'ÄÃ£ gá»­i':'ChÆ°a gá»­i'}</div></div>
        </div>`).join('')}
    </div>
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="ordersClose">ÄÃ³ng</button></div>
  </div>`, { onOpen: ()=> document.getElementById('ordersClose').addEventListener('click', hideModal) });
}

/* Admin panel (requires admin role) */
function openAdminPanel(){
  const cur = currentUser(); if(!cur || !(cur.roles||[]).includes('admin')){ toast('Chá»‰ admin Ä‘Æ°á»£c truy cáº­p', {type:'error'}); return; }
  const depositsHtml = renderDepositsForAdmin();
  showModal(`<div class="modal">
    <h3>Admin Panel</h3>
    <div style="display:flex;gap:12px;margin-top:12px">
      <div style="flex:1">
        <h4>Gift tiá»n</h4>
        <div style="display:flex;gap:8px;margin-top:8px"><input id="gift_user" placeholder="TÃªn user" style="flex:1;padding:8px;border-radius:8px"/><input id="gift_amount" placeholder="Sá»‘ tiá»n" style="width:120px;padding:8px;border-radius:8px"/></div>
        <div style="margin-top:8px"><button class="btn" id="gift_send">Gá»­i gift</button></div>
      </div>

      <div style="flex:1">
        <h4>YÃªu cáº§u náº¡p (pending)</h4>
        <div id="depositsList" style="max-height:260px;overflow:auto;margin-top:8px">${depositsHtml || '<div class="kv">KhÃ´ng cÃ³ yÃªu cáº§u</div>'}</div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px"><button class="btn" id="adminClose">ÄÃ³ng</button></div>
  </div>`, {
    onOpen: ()=>{
      document.getElementById('adminClose').addEventListener('click', hideModal);
      document.getElementById('gift_send').addEventListener('click', ()=>{
        const user = document.getElementById('gift_user').value.trim();
        const amt = Number(document.getElementById('gift_amount').value||0);
        if(!user || !amt){ toast('Nháº­p user vÃ  sá»‘ tiá»n', {type:'error'}); return; }
        try{ giftMoney(user, amt); toast(`ÄÃ£ gift ${fmt(amt)}Ä‘ cho ${user}`); renderHeader(); document.getElementById('gift_user').value=''; document.getElementById('gift_amount').value=''; }
        catch(err){ toast(err.message||'Lá»—i',{type:'error'}); }
      });
    }
  });
}

/* Admin helpers: gift, approve/decline deposit */
function giftMoney(username, amount){
  const users = Storage.getUsers();
  if(!users[username]) throw new Error('KhÃ´ng tÃ¬m tháº¥y user');
  users[username].balance = (users[username].balance || 0) + Number(amount || 0);
  Storage.saveUsers(users);
  Storage.pushLog({type:'admin_gift', to: username, amount, by: currentUser().username, time: now()});
}

function adminApproveDeposit(depositId){
  const cur = currentUser(); if(!cur || !(cur.roles||[]).includes('admin')){ toast('Chá»‰ admin', {type:'error'}); return; }
  const deposits = Storage.getDeposits();
  const idx = deposits.findIndex(d=>d.id===depositId);
  if(idx<0){ toast('KhÃ´ng tÃ¬m tháº¥y yÃªu cáº§u', {type:'error'}); return; }
  const dep = deposits[idx];
  if(dep.status !== 'pending'){ toast('ÄÃ£ xá»­ lÃ½ trÆ°á»›c Ä‘Ã³'); return; }
  dep.status = 'approved'; dep.processedBy = cur.username; dep.processedAt = now();
  Storage.saveDeposits(deposits);
  updateUserBalance(dep.username, dep.amount);
  Storage.pushLog({type:'deposit_approved', depositId, by:cur.username, time:now()});
  // re-render deposits list in modal if present
  const depositsList = document.getElementById('depositsList');
  if(depositsList) depositsList.innerHTML = renderDepositsForAdmin();
  renderHeader();
  toast(`ÄÃ£ cá»™ng ${fmt(dep.amount)}Ä‘ cho ${dep.username}`);
}

function adminDeclineDeposit(depositId){
  const cur = currentUser(); if(!cur || !(cur.roles||[]).includes('admin')){ toast('Chá»‰ admin', {type:'error'}); return; }
  const deposits = Storage.getDeposits(); const idx = deposits.findIndex(d=>d.id===depositId);
  if(idx<0){ toast('KhÃ´ng tÃ¬m tháº¥y yÃªu cáº§u', {type:'error'}); return; }
  deposits[idx].status = 'declined'; deposits[idx].processedBy = cur.username; deposits[idx].processedAt = now();
  Storage.saveDeposits(deposits);
  Storage.pushLog({type:'deposit_declined', depositId, by:cur.username, time:now()});
  const depositsList = document.getElementById('depositsList');
  if(depositsList) depositsList.innerHTML = renderDepositsForAdmin();
  toast('ÄÃ£ tá»« chá»‘i yÃªu cáº§u');
}

/* Create deposit request (user) */
function createDepositRequest(username, amount, bank, reference){
  const deposits = Storage.getDeposits();
  const req = { id:'d_'+now(), username, amount:Number(amount)||0, bank, reference, status:'pending', createdAt: now() };
  deposits.unshift(req); Storage.saveDeposits(deposits);
  Storage.pushLog({type:'deposit_created', user:username, amount:req.amount, reference, time:now()});
}

/* Render deposits list for admin (string) â€” used in admin modal */
function renderDepositsForAdmin(){
  const deposits = Storage.getDeposits();
  if(!deposits || deposits.length===0) return '';
  return deposits.map(d=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;background:var(--glass)">
      <div>
        <div><strong>${escapeHtml(d.username)}</strong> â€¢ <span class="kv">${escapeHtml(d.bank)} â€¢ Ref: ${escapeHtml(d.reference)}</span></div>
        <div class="kv">Sá»‘ tiá»n: ${fmt(d.amount)}Ä‘ â€” Tráº¡ng thÃ¡i: ${escapeHtml(d.status)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        ${d.status === 'pending' ? `<button class="btn admin-approve" data-deposit="${d.id}">Duyá»‡t</button><button class="btn secondary admin-decline" data-deposit="${d.id}">Tá»« chá»‘i</button>` : `<div class="kv">${escapeHtml(d.status)}</div>`}
      </div>
    </div>
  `).join('');
}

/* Admin panel open */
document.getElementById('openAdminPanel')?.addEventListener('click', openAdminPanel);

/* Delegation: admin approve/decline handled earlier via delegation */

/* Initial render */
function init(){
  renderPackages();
  renderOrdersPreview();
  renderHeader();
  // quick hook: admin button in admin placeholder
  document.getElementById('openAdminPanel')?.addEventListener('click', openAdminPanel);
  // if admin placeholder visible, admin badge shown by renderHeader
  // Wire admin open from placeholder if list changes
}
init();

/* Add event: open admin panel from placeholder (in case shown) */
document.getElementById('adminPanelPlaceholder')?.addEventListener('click', openAdminPanel);

/* Buttons linking: open admin panel from header area if admin */
document.getElementById('hdr-admin')?.addEventListener('click', openAdminPanel);

/* Setup navigation: renderPackages when sorting/search */
document.getElementById('searchInput').addEventListener('input', onSearch);
document.getElementById('sortSelect').addEventListener('change', ()=> onSearch());

/* Helper: attempt forwarding but not required */
async function forwardOrderToWebhook(order){
  if(!https://discord.com/api/webhooks/1465766093543964673/QfBdKIbYOgo5_s9S_YaJDF6vg6ZF8RyWwEw06uPZW3YtZuPUjCmODVJfdFmowfH1d9Gm) throw new Error('No webhook configured');
  const resp = await fetch(DISCORD_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(order) });
  if(!resp.ok) throw new Error('Forward failed: '+resp.status);
  return resp;
}

/* Small: expose login/logout from header (double-click header user to logout for demo) */
document.getElementById('hdr-user').addEventListener('dblclick', ()=>{
  if(confirm('ÄÄƒng xuáº¥t?')){ logoutUser(); toast('ÄÃ£ Ä‘Äƒng xuáº¥t'); }
});

/* Safe: prevent errors if missing openAdminPanel button in DOM */
if(!document.getElementById('openAdminPanel')) {
  // create and append if admin visible later
}

/* Expose simple public methods (for debugging) */
window.SNOWSHOP = {
  Storage, PACKAGES, registerUser, loginUser, logoutUser, giftMoney, createDepositRequest
};
</script>
</body>
</html>
